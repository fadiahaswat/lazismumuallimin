<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Test - Lazismu</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîí Security Features Test</h1>
    
    <div class="test-section">
        <h2>1. Rate Limiting Test</h2>
        <p>Click the button 6 times to test rate limiting (max 5 allowed):</p>
        <button onclick="testRateLimit()">Submit Test Request</button>
        <button onclick="resetRateLimit()">Reset Rate Limit</button>
        <div id="rate-limit-result"></div>
    </div>

    <div class="test-section">
        <h2>2. Input Validation Test</h2>
        <button onclick="testValidation()">Run Validation Tests</button>
        <div id="validation-result"></div>
    </div>

    <div class="test-section">
        <h2>3. Bot Detection Test</h2>
        <button onclick="testBotDetection()">Test Bot Detection</button>
        <div id="bot-result"></div>
    </div>

    <div class="test-section">
        <h2>4. Data Sanitization Test</h2>
        <button onclick="testSanitization()">Test XSS Protection</button>
        <div id="sanitization-result"></div>
    </div>

    <script type="module">
        import { 
            rateLimiter, 
            validateDonationData, 
            addSecurityHeaders,
            performSecurityChecks,
            initSecurityTracking,
            detectBotActivity
        } from './security-utils.js';

        // Make functions available globally for onclick
        window.rateLimiter = rateLimiter;
        window.validateDonationData = validateDonationData;
        window.addSecurityHeaders = addSecurityHeaders;
        window.performSecurityChecks = performSecurityChecks;
        window.initSecurityTracking = initSecurityTracking;
        window.detectBotActivity = detectBotActivity;

        // Initialize security tracking
        initSecurityTracking();

        // Test functions
        window.testRateLimit = function() {
            const result = rateLimiter.checkLimit();
            const resultDiv = document.getElementById('rate-limit-result');
            
            if (result.allowed) {
                rateLimiter.recordRequest();
                const remaining = 5 - rateLimiter.getData().requests.length;
                resultDiv.innerHTML += `
                    <div class="test-result success">
                        ‚úÖ Request allowed. Remaining: ${remaining}/5
                    </div>
                `;
            } else {
                resultDiv.innerHTML += `
                    <div class="test-result error">
                        ‚ùå ${result.message}
                    </div>
                `;
            }
        };

        window.resetRateLimit = function() {
            rateLimiter.reset();
            document.getElementById('rate-limit-result').innerHTML = `
                <div class="test-result success">
                    ‚úÖ Rate limit reset successfully
                </div>
            `;
        };

        window.testValidation = function() {
            const testCases = [
                {
                    name: "Valid Data",
                    data: {
                        type: "zakat",
                        nominal: 50000,
                        nama: "John Doe",
                        hp: "081234567890",
                        email: "john@example.com",
                        metode: "bni"
                    },
                    shouldPass: true
                },
                {
                    name: "Nominal Too Low",
                    data: {
                        type: "zakat",
                        nominal: 500,
                        nama: "John Doe",
                        hp: "081234567890",
                        metode: "bni"
                    },
                    shouldPass: false
                },
                {
                    name: "Invalid Email",
                    data: {
                        type: "zakat",
                        nominal: 50000,
                        nama: "John Doe",
                        hp: "081234567890",
                        email: "invalid-email",
                        metode: "bni"
                    },
                    shouldPass: false
                },
                {
                    name: "XSS Attempt",
                    data: {
                        type: "zakat",
                        nominal: 50000,
                        nama: "<script>alert('XSS')</script>John",
                        hp: "081234567890",
                        metode: "bni"
                    },
                    shouldPass: true
                }
            ];

            let html = '<h3>Validation Results:</h3>';
            testCases.forEach(test => {
                const result = validateDonationData(test.data);
                const passed = result.isValid === test.shouldPass;
                
                html += `
                    <div class="test-result ${passed ? 'success' : 'error'}">
                        ${passed ? '‚úÖ' : '‚ùå'} ${test.name}: ${result.isValid ? 'VALID' : 'INVALID'}
                        ${!result.isValid ? '<br>Errors: ' + result.errors.join(', ') : ''}
                    </div>
                `;
            });

            document.getElementById('validation-result').innerHTML = html;
        };

        window.testBotDetection = function() {
            const isBot = detectBotActivity();
            const resultDiv = document.getElementById('bot-result');
            
            resultDiv.innerHTML = `
                <div class="test-result ${isBot ? 'error' : 'success'}">
                    ${isBot ? '‚ö†Ô∏è Bot activity detected!' : '‚úÖ No bot activity detected'}
                </div>
                <pre>
WebDriver: ${window.navigator.webdriver || 'not detected'}
Plugins: ${navigator.plugins.length}
User Interaction: ${window.hasUserInteraction || 'not yet'}
                </pre>
            `;
        };

        window.testSanitization = function() {
            const testInputs = [
                '<script>alert("XSS")</script>',
                'Normal text',
                '<img src=x onerror=alert(1)>',
                'javascript:alert(1)',
                '<a href="javascript:void(0)" onclick="alert(1)">Click</a>'
            ];

            const testData = {
                type: "zakat",
                nominal: 50000,
                nama: "",
                hp: "081234567890",
                metode: "bni"
            };

            let html = '<h3>Sanitization Results:</h3>';
            testInputs.forEach(input => {
                testData.nama = input;
                const result = validateDonationData(testData);
                
                html += `
                    <div class="test-result success">
                        <strong>Input:</strong> <code>${input}</code><br>
                        <strong>Sanitized:</strong> <code>${result.sanitizedData.nama}</code>
                    </div>
                `;
            });

            document.getElementById('sanitization-result').innerHTML = html;
        };
    </script>
</body>
</html>
