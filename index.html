<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lazismu Mu'allimin - Menempa Kader, Memberdaya Umat</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <meta property="og:title" content="Lazismu Mu'allimin">
    <meta property="og:description" content="Mari salurkan Zakat, Infaq, dan Shodaqoh melalui Lazismu Mu'allimin. Amanah dan Profesional.">
    <meta property="og:image" content="https://lazismumuallimin.org/thumbnail.jpg">
    <meta property="og:url" content="https://lazismumuallimin.org">
    <meta property="og:type" content="website">
    <meta name="description" content="Portal Donasi & Berita Resmi Lazismu Madrasah Mu'allimin Muhammadiyah Yogyakarta">
    
    <!-- Framework & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script src="data-santri.js"></script> <script src="data-kelas.js"></script>

    <!-- Configuration & Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        arabic: ['Amiri', 'serif'],
                    },
                    colors: {
                        brand: {
                            orange: '#F15A22',
                            dark: '#1e293b',
                        }
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0,0,0,0.05)',
                        'glow': '0 0 20px rgba(241, 90, 34, 0.15)',
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        <link rel="stylesheet" href="style.css">
    </style>
</head>
<body class="text-slate-600 flex flex-col min-h-screen font-sans">

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- MODAL HUBUNGI KAMI -->
    <div id="hubungi-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-8 relative animate-fade-in-up">
            <button id="hubungi-modal-close" class="absolute top-4 right-4 w-8 h-8 bg-slate-100 hover:bg-slate-200 rounded-full flex items-center justify-center text-slate-500 transition-colors">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="text-2xl font-bold text-slate-800 mb-2 text-center">Pusat Bantuan</h3>
            <p class="text-center text-slate-500 mb-8">Silakan pilih layanan kebaikan yang Anda butuhkan.</p>
            <div class="space-y-4">
                <a href="https://wa.me/6281196961918?text=Assalamu'alaikum%2C%20saya%20ingin%20berkonsultasi%20tentang%20program%20kebaikan%20ZIS." target="_blank" class="flex items-center p-4 bg-green-50 rounded-2xl hover:bg-green-100 transition group cursor-pointer border border-transparent hover:border-green-200">
                    <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-white text-xl mr-4 shadow-lg shadow-green-500/30">
                        <i class="fab fa-whatsapp"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-800">Chat Konsultasi</h4>
                        <p class="text-sm text-slate-600">Tanya jawab seputar ZIS via WhatsApp.</p>
                    </div>
                </a>
                <button onclick="document.getElementById('hubungi-modal').classList.add('hidden'); showPage('donasi');" class="w-full flex items-center p-4 bg-orange-50 rounded-2xl hover:bg-orange-100 transition group text-left cursor-pointer border border-transparent hover:border-orange-200">
                    <div class="w-12 h-12 bg-orange-500 rounded-full flex items-center justify-center text-white text-xl mr-4 shadow-lg shadow-orange-500/30">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-800">Konfirmasi ZIS</h4>
                        <p class="text-sm text-slate-600">Isi formulir donasi untuk konfirmasi kebaikan.</p>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL NEWS DETAIL -->
    <div id="news-modal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4 transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl relative transform scale-95 transition-transform duration-300 flex flex-col" id="news-modal-panel">
            <button onclick="closeNewsModal()" class="absolute top-4 right-4 z-20 bg-white/80 hover:bg-red-500 hover:text-white text-gray-800 p-2 rounded-full w-10 h-10 shadow-md transition">
                <i class="fas fa-times"></i>
            </button>
            <div id="news-modal-content" class="flex-grow">
                <!-- Injected by JS -->
            </div>
        </div>
    </div>

    <!-- MODAL SUCCESS -->
     <div id="success-modal" class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-md z-[100] flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-8 text-center transform scale-100 transition-transform duration-300 animate-fade-in-up relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-green-400 to-green-600"></div>
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 animate-bounce shadow-lg shadow-green-100">
                <i class="fas fa-check text-4xl text-green-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-slate-800 mb-2">Alhamdulillah!</h3>
            <p class="text-slate-600 mb-8">Niat kebaikan Anda berhasil dicatat.<br>Jazakumullah Khairan Katsiran.</p>
            <button id="success-modal-continue" class="w-full bg-slate-900 text-white px-6 py-4 rounded-xl font-bold hover:bg-slate-800 transition-colors shadow-xl shadow-slate-900/20 cursor-pointer">
                Lanjut Pembayaran <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>
    </div>

    <!-- NAVBAR -->
    <header class="bg-white/90 backdrop-blur-md border-b border-slate-100 sticky top-0 z-50 transition-all duration-300">
        <nav class="container mx-auto px-4 md:px-6 py-4 flex justify-between items-center">
            <a href="#home" class="flex items-center group cursor-pointer select-none" onclick="showPage('home')">
    
    <img src="logo.png" alt="Logo Lazismu" class="h-10 md:h-14 w-auto transition-transform duration-300 group-hover:scale-105">

</a>
            <button id="menu-toggle" class="md:hidden w-10 h-10 flex items-center justify-center text-slate-600 hover:bg-slate-100 rounded-lg transition">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <div id="menu-links" class="hidden md:flex md:items-center gap-2 absolute md:relative top-full left-0 w-full md:w-auto bg-white/95 md:bg-transparent shadow-lg md:shadow-none p-4 md:p-0 flex-col md:flex-row border-b md:border-0 border-slate-100 transition-all duration-300 backdrop-blur-md md:backdrop-blur-none">
                <a href="#home" onclick="showPage('home'); return false;" class="nav-link px-4 py-2 rounded-lg hover:bg-orange-50 text-slate-600 hover:text-brand-orange transition font-bold text-sm w-full md:w-auto text-center">Beranda</a>
                <a href="#berita" onclick="showPage('berita'); return false;" class="nav-link px-4 py-2 rounded-lg hover:bg-orange-50 text-slate-600 hover:text-brand-orange transition font-bold text-sm w-full md:w-auto text-center">Kabar Berita</a>
                <a href="#riwayat" onclick="showPage('riwayat'); return false;" class="nav-link px-4 py-2 rounded-lg hover:bg-orange-50 text-slate-600 hover:text-brand-orange transition font-bold text-sm w-full md:w-auto text-center">Laporan & Statistik</a>
                <a href="#rekapitulasi" onclick="showPage('rekapitulasi'); return false;" class="nav-link px-4 py-2 rounded-lg hover:bg-orange-50 text-slate-600 hover:text-brand-orange transition font-bold text-sm w-full md:w-auto text-center">Rekapitulasi</a>
                <a href="#donasi" onclick="showPage('donasi'); return false;" class="mt-2 md:mt-0 bg-slate-900 text-white px-5 py-2.5 rounded-full font-bold text-sm hover:bg-brand-orange transition shadow-lg shadow-orange-500/20 flex items-center justify-center gap-2 w-full md:w-auto text-center cursor-pointer">
                    <i class="fas fa-heart text-orange-500"></i> Donasi Sekarang
                </a>
            </div>
        </nav>
    </header>

    <main class="flex-grow">
        <!-- === HOME SECTION === -->
         <section id="page-home" class="page-section">
            <!-- Hero -->
            <div class="relative bg-slate-900 overflow-hidden rounded-b-[3rem] mb-12 shadow-2xl shadow-slate-900/20">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                <div class="absolute -top-24 -right-24 w-96 h-96 bg-orange-500 rounded-full blur-[100px] opacity-20"></div>
                <div class="absolute bottom-0 left-0 w-full h-24 bg-gradient-to-t from-slate-900 to-transparent"></div>
                <div class="container mx-auto px-4 py-16 md:py-28 text-center relative z-10">
                    <span class="inline-block py-1 px-3 rounded-full bg-white/10 backdrop-blur text-orange-300 text-xs font-bold tracking-wider mb-6 border border-white/10">LEMBAGA AMIL ZAKAT TERPERCAYA</span>
                    <h1 class="text-5xl md:text-7xl font-black text-white mb-6 leading-tight tracking-tight drop-shadow-2xl animate-fade-in-up">
                        Amanah Mengelola,<br><span class="text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-yellow-400">Memberdaya Sesama</span>
                    </h1>
                    <p class="text-slate-400 text-lg md:text-2xl max-w-2xl mx-auto mb-10 font-light leading-relaxed px-4 animate-fade-in-up stagger-1">
                        Salurkan Zakat, Infaq, dan Shodaqoh Anda melalui Lazismu Mu'allimin Yogyakarta untuk menebar kebaikan bagi pendidikan kader umat.
                    </p>
                    <div class="flex flex-wrap justify-center gap-4 mb-8 max-w-5xl mx-auto px-2 relative z-30 animate-fade-in-up stagger-2">
                        <button onclick="showPage('donasi')" class="bg-brand-orange text-white px-8 py-4 rounded-full font-bold text-lg hover:bg-orange-600 transition shadow-lg shadow-orange-500/30 flex items-center justify-center gap-2 w-full sm:w-auto transform hover:-translate-y-1">
                            <i class="fas fa-hand-holding-heart"></i> Tunaikan ZIS
                        </button>
                        <button onclick="scrollToSection('donasi-rekening')" class="bg-white/10 backdrop-blur text-white px-6 py-3 rounded-full font-bold text-lg hover:bg-white/20 transition flex items-center justify-center gap-2 w-full sm:w-auto cursor-pointer border border-white/10 transform hover:-translate-y-1">
                            <i class="fas fa-wallet"></i> Daftar Rekening
                        </button>
                        <button onclick="scrollToSection('qris-section')" class="bg-white/10 backdrop-blur text-white px-6 py-3 rounded-full font-bold text-lg hover:bg-white/20 transition flex items-center justify-center gap-2 w-full sm:w-auto cursor-pointer border border-white/10 transform hover:-translate-y-1">
                            <i class="fas fa-qrcode"></i> Scan QRIS
                        </button>
                        <button id="btn-hubungi-hero" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-full font-bold text-lg transition shadow-lg shadow-green-500/30 flex items-center justify-center gap-2 w-full sm:w-auto cursor-pointer transform hover:-translate-y-1">
                            <i class="far fa-comments"></i> Hubungi Kami
                        </button>
                    </div>
                </div>
            </div>

            <!-- 1. Capaian Kebaikan (REDESIGNED) -->
            <div class="container mx-auto px-4 -mt-24 relative z-20 mb-16">
                <div class="bg-white/90 backdrop-blur-xl rounded-[2.5rem] shadow-2xl border border-white/60 p-8 md:p-10 relative overflow-hidden">
                     <!-- Background Pattern -->
                    <div class="absolute top-0 right-0 w-64 h-64 bg-orange-50 rounded-full mix-blend-multiply filter blur-3xl opacity-50 -mt-10 -mr-10 pointer-events-none"></div>
                    <div class="absolute bottom-0 left-0 w-64 h-64 bg-blue-50 rounded-full mix-blend-multiply filter blur-3xl opacity-50 -mb-10 -ml-10 pointer-events-none"></div>

                    <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-10 border-b border-slate-100 pb-6 relative z-10">
                        <div>
                            <h2 class="text-3xl font-black text-slate-800 flex items-center gap-4">
                                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-orange-400 to-red-500 flex items-center justify-center text-white text-xl shadow-lg shadow-orange-500/30">
                                    <i class="fas fa-chart-pie"></i>
                                </div>
                                Capaian Kebaikan
                            </h2>
                            <p class="text-slate-500 mt-2 text-lg ml-16">Pantau dampak nyata donasi Anda secara real-time.</p>
                        </div>
                        <a href="#" onclick="showPage('riwayat'); return false;" class="group flex items-center gap-2 text-brand-orange font-bold hover:bg-orange-50 px-5 py-3 rounded-xl transition-all duration-300 mt-4 md:mt-0">
                            Lihat Detail Laporan
                            <i class="fas fa-arrow-right transition-transform group-hover:translate-x-1"></i>
                        </a>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 relative z-10">
                        <!-- Card 1: Total Donasi -->
                        <div class="group relative bg-gradient-to-br from-orange-50 to-white p-6 rounded-3xl border border-orange-100 hover:border-orange-300 hover:shadow-xl hover:shadow-orange-500/10 transition-all duration-500 transform hover:-translate-y-2">
                            <div class="absolute top-4 right-4 text-orange-200 text-6xl opacity-20 group-hover:scale-110 group-hover:rotate-12 transition-transform duration-500"><i class="fas fa-hand-holding-heart"></i></div>
                            <div class="w-14 h-14 rounded-2xl bg-orange-100 text-orange-600 flex items-center justify-center text-2xl mb-4 shadow-sm group-hover:bg-orange-500 group-hover:text-white transition-colors duration-300">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <p class="text-xs font-bold text-orange-600 uppercase tracking-widest mb-1">Total Donasi</p>
                            <h3 id="stat-total-donasi" class="text-2xl font-black text-slate-800 group-hover:text-orange-600 transition-colors">Rp 0</h3>
                        </div>

                        <!-- Card 2: Total Transaksi -->
                        <div class="group relative bg-gradient-to-br from-blue-50 to-white p-6 rounded-3xl border border-blue-100 hover:border-blue-300 hover:shadow-xl hover:shadow-blue-500/10 transition-all duration-500 transform hover:-translate-y-2">
                            <div class="absolute top-4 right-4 text-blue-200 text-6xl opacity-20 group-hover:scale-110 group-hover:rotate-12 transition-transform duration-500"><i class="fas fa-receipt"></i></div>
                            <div class="w-14 h-14 rounded-2xl bg-blue-100 text-blue-600 flex items-center justify-center text-2xl mb-4 shadow-sm group-hover:bg-blue-500 group-hover:text-white transition-colors duration-300">
                                <i class="fas fa-users"></i>
                            </div>
                            <p class="text-xs font-bold text-blue-600 uppercase tracking-widest mb-1">Total Transaksi</p>
                            <h3 id="stat-total-transaksi" class="text-2xl font-black text-slate-800 group-hover:text-blue-600 transition-colors">0</h3>
                        </div>

                        <!-- Card 3: Rata-rata -->
                        <div class="group relative bg-gradient-to-br from-teal-50 to-white p-6 rounded-3xl border border-teal-100 hover:border-teal-300 hover:shadow-xl hover:shadow-teal-500/10 transition-all duration-500 transform hover:-translate-y-2">
                            <div class="absolute top-4 right-4 text-teal-200 text-6xl opacity-20 group-hover:scale-110 group-hover:rotate-12 transition-transform duration-500"><i class="fas fa-balance-scale"></i></div>
                            <div class="w-14 h-14 rounded-2xl bg-teal-100 text-teal-600 flex items-center justify-center text-2xl mb-4 shadow-sm group-hover:bg-teal-500 group-hover:text-white transition-colors duration-300">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <p class="text-xs font-bold text-teal-600 uppercase tracking-widest mb-1">Rata-rata Donasi</p>
                            <h3 id="stat-donasi-rata" class="text-2xl font-black text-slate-800 group-hover:text-teal-600 transition-colors">Rp 0</h3>
                        </div>

                        <!-- Card 4: Tertinggi -->
                        <div class="group relative bg-gradient-to-br from-yellow-50 to-white p-6 rounded-3xl border border-yellow-200 hover:border-yellow-400 hover:shadow-xl hover:shadow-yellow-500/10 transition-all duration-500 transform hover:-translate-y-2">
                            <div class="absolute top-4 right-4 text-yellow-200 text-6xl opacity-20 group-hover:scale-110 group-hover:rotate-12 transition-transform duration-500"><i class="fas fa-crown"></i></div>
                            <div class="w-14 h-14 rounded-2xl bg-yellow-100 text-yellow-600 flex items-center justify-center text-2xl mb-4 shadow-sm group-hover:bg-yellow-500 group-hover:text-white transition-colors duration-300">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <p class="text-xs font-bold text-yellow-600 uppercase tracking-widest mb-1">Donasi Tertinggi</p>
                            <h3 id="stat-donasi-tertinggi" class="text-2xl font-black text-slate-800 group-hover:text-yellow-600 transition-colors">Rp 0</h3>
                             <p id="stat-donasi-tertinggi-nama" class="text-xs text-slate-400 truncate mt-1 font-medium bg-white/50 px-2 py-1 rounded-lg inline-block border border-yellow-100">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Jejak Kebaikan Terbaru (Redesigned) -->
            <section class="py-12 bg-slate-50 border-y border-slate-200 relative overflow-hidden mb-20">
                <!-- Decorative elements -->
                <div class="absolute top-0 right-0 -mt-10 -mr-10 w-40 h-40 bg-orange-100 rounded-full opacity-50 blur-3xl"></div>
                <div class="absolute bottom-0 left-0 -mb-10 -ml-10 w-40 h-40 bg-blue-100 rounded-full opacity-50 blur-3xl"></div>

                <div class="container mx-auto px-4 relative z-10">
                    <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <span class="relative flex h-3 w-3">
                                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                  <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                                </span>
                                <span class="text-green-600 font-bold text-xs uppercase tracking-widest">Live Update</span>
                            </div>
                            <h2 class="text-3xl font-bold text-slate-800">Jejak Kebaikan Terbaru</h2>
                            <p class="text-slate-500 mt-1">Setiap rupiah adalah saksi ketulusan hati.</p>
                        </div>
                        <a href="#" onclick="showPage('riwayat'); return false;" class="group flex items-center gap-2 text-slate-600 hover:text-brand-orange font-semibold transition-colors">
                            Lihat Semua Riwayat
                            <i class="fas fa-arrow-right transition-transform group-hover:translate-x-1"></i>
                        </a>
                    </div>

                    <div id="home-latest-donations" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                        <!-- Loading Skeleton -->
                        <div class="col-span-full text-center py-12">
                            <div class="animate-spin inline-block w-8 h-8 border-4 border-slate-200 border-t-orange-500 rounded-full mb-4"></div>
                            <p class="text-slate-400 text-sm">Sedang mengambil data...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. Statistik Santri (REDESIGNED & ALIGNED) -->
             <section class="py-20 relative overflow-hidden">
                <!-- Background Decoration Blobs -->
                <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
                    <div class="absolute top-20 -left-10 w-72 h-72 bg-orange-100 rounded-full mix-blend-multiply filter blur-3xl opacity-40 animate-pulse"></div>
                    <div class="absolute bottom-20 -right-10 w-72 h-72 bg-blue-100 rounded-full mix-blend-multiply filter blur-3xl opacity-40 animate-pulse" style="animation-delay: 2s"></div>
                </div>

                <div class="container mx-auto px-4 relative z-10">
                     <div class="text-center mb-16">
                        <div class="inline-block p-4 rounded-3xl bg-white shadow-glow mb-6 transform hover:rotate-3 transition duration-500">
                            <div class="w-14 h-14 bg-gradient-to-br from-orange-400 to-red-500 rounded-2xl flex items-center justify-center text-white text-3xl shadow-lg">
                                <i class="fas fa-crown"></i>
                            </div>
                        </div>
                        <h2 class="text-4xl md:text-5xl font-black text-slate-800 mb-4 tracking-tight">Pahlawan Kebaikan</h2>
                        <p class="text-slate-500 text-lg max-w-2xl mx-auto">Apresiasi tertinggi untuk santri yang berlomba-lomba dalam kebaikan (Fastabiqul Khairat).</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
                        
                        <!-- CARD MTs (Junior Level) -->
                        <div class="group relative bg-white rounded-[2.5rem] shadow-xl border border-slate-100 overflow-hidden hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-1 flex flex-col">
                            <!-- Header Color (Sejajar & Rapi) -->
                            <div class="relative w-full h-40 bg-gradient-to-r from-teal-500 to-emerald-600 flex items-center px-8 overflow-hidden shrink-0">
                                <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-white opacity-10 rounded-full"></div>
                                <div class="absolute top-10 left-10 w-20 h-20 bg-white opacity-10 rounded-full"></div>
                                <!-- Pattern Overlay -->
                                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20"></div>
                                
                                <!-- Badge Level (Centered Vertically in Header) -->
                                <div class="relative z-10 flex items-center gap-6 w-full">
                                    <div class="w-20 h-20 bg-white rounded-2xl shadow-lg flex items-center justify-center text-3xl text-teal-600 font-black border-4 border-teal-100 shrink-0 transform group-hover:scale-105 transition duration-300">
                                        MTs
                                    </div>
                                    <div class="text-white drop-shadow-md flex flex-col justify-center">
                                        <h3 class="text-2xl md:text-3xl font-bold leading-tight">Tingkat Tsanawiyah</h3>
                                        <div class="mt-2">
                                            <span class="text-teal-800 bg-teal-50/90 font-bold text-xs uppercase tracking-wider px-3 py-1 rounded-full backdrop-blur-sm shadow-sm">
                                                Kelas 1, 2, & 3
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-8 flex-grow flex flex-col justify-center">
                                <!-- Stats List -->
                                <div class="space-y-5">
                                    <!-- 1. Kelas Terbanyak -->
                                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex items-center gap-5 hover:border-teal-200 hover:shadow-lg hover:shadow-teal-500/5 transition-all duration-300 group/item">
                                        <div class="w-14 h-14 rounded-full bg-teal-50 flex items-center justify-center text-teal-600 text-xl group-hover/item:scale-110 group-hover/item:bg-teal-500 group-hover/item:text-white transition-all duration-300 shadow-sm shrink-0">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-0.5">Kelas Paling Kompak</p>
                                            <h4 id="stat-mts-kelas-max" class="text-lg md:text-xl font-black text-slate-800 truncate">N/A</h4>
                                        </div>
                                        <div class="text-right shrink-0">
                                            <span id="stat-mts-kelas-total" class="block text-xs md:text-sm font-bold text-teal-700 bg-teal-50 px-3 py-1.5 rounded-lg">Rp 0</span>
                                        </div>
                                    </div>

                                    <!-- 2. Santri Tertinggi (Special Gold Style) -->
                                    <div class="bg-gradient-to-r from-amber-50 to-yellow-50 rounded-2xl p-4 shadow-md border border-amber-200 flex items-center gap-5 hover:shadow-xl hover:shadow-orange-500/10 transition-all duration-300 relative overflow-hidden group/gold">
                                        <div class="absolute -right-6 -top-6 text-amber-200 text-8xl opacity-20 rotate-12 group-hover/gold:rotate-45 transition-transform duration-700"><i class="fas fa-trophy"></i></div>
                                        <div class="w-14 h-14 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-white text-xl shadow-lg shadow-orange-500/30 z-10 group-hover/gold:scale-110 group-hover/gold:rotate-12 transition-all duration-300 shrink-0">
                                            <i class="fas fa-crown"></i>
                                        </div>
                                        <div class="flex-1 min-w-0 z-10">
                                            <p class="text-[10px] font-bold text-amber-600 uppercase tracking-wider mb-0.5">Donasi Tertinggi</p>
                                            <h4 id="stat-mts-santri-max-donasi" class="text-lg md:text-xl font-black text-slate-800 truncate">N/A</h4>
                                        </div>
                                        <div class="text-right shrink-0 z-10">
                                            <span id="stat-mts-santri-total-donasi" class="block text-xs md:text-sm font-bold text-amber-700 bg-white/60 px-3 py-1.5 rounded-lg backdrop-blur-sm border border-amber-100 shadow-sm">Rp 0</span>
                                        </div>
                                    </div>

                                    <!-- 3. Santri Paling Sering -->
                                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex items-center gap-5 hover:border-teal-200 hover:shadow-lg hover:shadow-teal-500/5 transition-all duration-300 group/item">
                                        <div class="w-14 h-14 rounded-full bg-teal-50 flex items-center justify-center text-teal-600 text-xl group-hover/item:scale-110 group-hover/item:bg-teal-500 group-hover/item:text-white transition-all duration-300 shadow-sm shrink-0">
                                            <i class="fas fa-bolt"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-0.5">Paling Rajin (Frekuensi)</p>
                                            <h4 id="stat-mts-santri-freq-nama" class="text-lg md:text-xl font-black text-slate-800 truncate">N/A</h4>
                                        </div>
                                        <div class="text-right shrink-0">
                                            <span id="stat-mts-santri-freq-val" class="block text-xs md:text-sm font-bold text-teal-700 bg-teal-50 px-3 py-1.5 rounded-lg">0x</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CARD MA (Senior Level) -->
                        <div class="group relative bg-white rounded-[2.5rem] shadow-xl border border-slate-100 overflow-hidden hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-1 flex flex-col">
                            <!-- Header Color (Sejajar & Rapi) -->
                            <div class="relative w-full h-40 bg-gradient-to-r from-blue-600 to-indigo-700 flex items-center px-8 overflow-hidden shrink-0">
                                <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-white opacity-10 rounded-full"></div>
                                <div class="absolute top-10 right-10 w-20 h-20 bg-white opacity-10 rounded-full"></div>
                                 <!-- Pattern Overlay -->
                                 <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20"></div>
                                
                                <!-- Badge Level (Centered Vertically in Header) -->
                                <div class="relative z-10 flex items-center gap-6 w-full">
                                    <div class="w-20 h-20 bg-white rounded-2xl shadow-lg flex items-center justify-center text-3xl text-indigo-600 font-black border-4 border-indigo-100 shrink-0 transform group-hover:scale-105 transition duration-300">
                                        MA
                                    </div>
                                    <div class="text-white drop-shadow-md flex flex-col justify-center">
                                        <h3 class="text-2xl md:text-3xl font-bold leading-tight">Tingkat Aliyah</h3>
                                        <div class="mt-2">
                                            <span class="text-indigo-800 bg-indigo-50/90 font-bold text-xs uppercase tracking-wider px-3 py-1 rounded-full backdrop-blur-sm shadow-sm">
                                                Kelas 4, 5, & 6
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-8 flex-grow flex flex-col justify-center">
                                <!-- Stats List -->
                                <div class="space-y-5">
                                    <!-- 1. Kelas Terbanyak -->
                                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex items-center gap-5 hover:border-indigo-200 hover:shadow-lg hover:shadow-indigo-500/5 transition-all duration-300 group/item">
                                        <div class="w-14 h-14 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 text-xl group-hover/item:scale-110 group-hover/item:bg-indigo-500 group-hover/item:text-white transition-all duration-300 shadow-sm shrink-0">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-0.5">Kelas Paling Kompak</p>
                                            <h4 id="stat-ma-kelas-max" class="text-lg md:text-xl font-black text-slate-800 truncate">N/A</h4>
                                        </div>
                                        <div class="text-right shrink-0">
                                            <span id="stat-ma-kelas-total" class="block text-xs md:text-sm font-bold text-indigo-700 bg-indigo-50 px-3 py-1.5 rounded-lg">Rp 0</span>
                                        </div>
                                    </div>

                                    <!-- 2. Santri Tertinggi (Special Gold Style) -->
                                    <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl p-4 shadow-md border border-amber-200 flex items-center gap-5 hover:shadow-xl hover:shadow-orange-500/10 transition-all duration-300 relative overflow-hidden group/gold">
                                        <div class="absolute -right-6 -top-6 text-amber-200 text-8xl opacity-20 rotate-12 group-hover/gold:rotate-45 transition-transform duration-700"><i class="fas fa-trophy"></i></div>
                                        <div class="w-14 h-14 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-white text-xl shadow-lg shadow-orange-500/30 z-10 group-hover/gold:scale-110 group-hover/gold:rotate-12 transition-all duration-300 shrink-0">
                                            <i class="fas fa-crown"></i>
                                        </div>
                                        <div class="flex-1 min-w-0 z-10">
                                            <p class="text-[10px] font-bold text-amber-600 uppercase tracking-wider mb-0.5">Donasi Tertinggi</p>
                                            <h4 id="stat-ma-santri-max-donasi" class="text-lg md:text-xl font-black text-slate-800 truncate">N/A</h4>
                                        </div>
                                        <div class="text-right shrink-0 z-10">
                                            <span id="stat-ma-santri-total-donasi" class="block text-xs md:text-sm font-bold text-amber-700 bg-white/60 px-3 py-1.5 rounded-lg backdrop-blur-sm border border-amber-100 shadow-sm">Rp 0</span>
                                        </div>
                                    </div>

                                    <!-- 3. Santri Paling Sering -->
                                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex items-center gap-5 hover:border-indigo-200 hover:shadow-lg hover:shadow-indigo-500/5 transition-all duration-300 group/item">
                                        <div class="w-14 h-14 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 text-xl group-hover/item:scale-110 group-hover/item:bg-indigo-500 group-hover/item:text-white transition-all duration-300 shadow-sm shrink-0">
                                            <i class="fas fa-bolt"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-0.5">Paling Rajin (Frekuensi)</p>
                                            <h4 id="stat-ma-santri-freq-nama" class="text-lg md:text-xl font-black text-slate-800 truncate">N/A</h4>
                                        </div>
                                        <div class="text-right shrink-0">
                                            <span id="stat-ma-santri-freq-val" class="block text-xs md:text-sm font-bold text-indigo-700 bg-indigo-50 px-3 py-1.5 rounded-lg">0x</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
             </section>
             
             <!-- 5. Metode Pembayaran (QRIS & Transfer) -->
             <section id="qris-section" class="py-20">
                <div class="container mx-auto px-4">
                    <div class="text-center mb-12"><h2 class="text-2xl md:text-3xl font-bold text-slate-800 mb-3 flex items-center justify-center gap-2"><i class="fas fa-wallet text-orange-500"></i> Metode Pembayaran</h2><p class="text-slate-500">Pilih metode yang paling memudahkan niat baik Anda.</p></div>
                     <!-- QRIS -->
                    <div class="max-w-5xl mx-auto soft-card p-8 mb-12 rounded-3xl flex flex-col md:flex-row items-start gap-8">
                         <div class="flex-1 text-center md:text-left">
                            <div class="inline-block p-3 rounded-2xl bg-orange-50 text-orange-600 mb-4"><i class="fas fa-qrcode text-2xl"></i></div>
                            <h3 class="text-2xl font-bold text-slate-800 mb-2">Scan QRIS</h3>
                            <p class="text-slate-500 mb-6">Support GoPay, OVO, Dana, LinkAja, ShopeePay, & M-Banking.</p>
                            <div class="flex flex-wrap gap-3 justify-center md:justify-start">
                                <a href="https://drive.google.com/uc?export=download&id=1sVzvP6AUz_bYJ31CzQG2io9oJvdMDywt" target="_blank" class="px-5 py-3 rounded-xl bg-orange-600 text-white font-bold hover:bg-orange-700 transition text-sm shadow-lg shadow-orange-500/20 transform hover:-translate-y-1"><i class="fas fa-download mr-2"></i> Unduh QRIS BNI</a>
                                <a href="https://drive.google.com/uc?export=download&id=1xNHeckecd8Pn_7dSOQ0KfGcl0I_FCY9V" target="_blank" class="px-5 py-3 rounded-xl bg-teal-600 text-white font-bold hover:bg-teal-700 transition text-sm shadow-lg shadow-teal-500/20 transform hover:-translate-y-1"><i class="fas fa-download mr-2"></i> Unduh QRIS BSI</a>
                                <a href="https://drive.google.com/uc?export=download&id=1BHYcMAUp3OiVeRx2HwjPPEu2StcYiUpm" target="_blank" class="px-5 py-3 rounded-xl bg-blue-700 text-white font-bold hover:bg-blue-800 transition text-sm shadow-lg shadow-blue-500/20 transform hover:-translate-y-1"><i class="fas fa-download mr-2"></i> Unduh QRIS BPD</a>
                            </div>
                        </div>
                        <div class="flex-1 w-full grid grid-cols-3 gap-4">
                             <div class="text-center group cursor-pointer"><div class="bg-slate-50 p-2 rounded-xl mb-2 group-hover:bg-white group-hover:shadow-lg transition"><img src="https://drive.google.com/thumbnail?id=1sVzvP6AUz_bYJ31CzQG2io9oJvdMDywt" class="w-full h-auto rounded-lg"></div><span class="text-xs font-bold text-slate-500">BNI</span></div>
                             <div class="text-center group cursor-pointer"><div class="bg-slate-50 p-2 rounded-xl mb-2 group-hover:bg-white group-hover:shadow-lg transition"><img src="https://drive.google.com/thumbnail?id=1xNHeckecd8Pn_7dSOQ0KfGcl0I_FCY9V" class="w-full h-auto rounded-lg"></div><span class="text-xs font-bold text-slate-500">BSI</span></div>
                             <div class="text-center group cursor-pointer"><div class="bg-slate-50 p-2 rounded-xl mb-2 group-hover:bg-white group-hover:shadow-lg transition"><img src="https://drive.google.com/thumbnail?id=1BHYcMAUp3OiVeRx2HwjPPEu2StcYiUpm" class="w-full h-auto rounded-lg"></div><span class="text-xs font-bold text-slate-500">BPD DIY</span></div>
                        </div>
                    </div>
                     <!-- Transfer -->
                    <div id="donasi-rekening" class="max-w-5xl mx-auto soft-card p-8 rounded-3xl flex flex-col md:flex-row items-start gap-8 mt-16">
                        <div class="flex-1 text-center md:text-left">
                            <div class="inline-block p-3 rounded-2xl bg-blue-50 text-blue-600 mb-4"><i class="fas fa-university text-2xl"></i></div>
                            <h3 class="text-2xl font-bold text-slate-800 mb-2">Transfer Bank</h3>
                            <p class="text-slate-500 mb-6">Salurkan donasi melalui transfer manual ke rekening resmi berikut.</p>
                        </div>
                        <div class="flex-1 w-full flex flex-col gap-4">
                             <div class="p-5 rounded-2xl flex items-center justify-between bg-slate-50 hover:bg-white hover:shadow-md transition border border-slate-100 group">
                                <div>
                                    <div class="flex items-center gap-2 mb-1"><span class="font-bold text-slate-800">BNI</span> <span class="text-xs bg-slate-200 px-2 rounded text-slate-500">009</span></div>
                                    <p class="font-mono text-lg text-slate-600 group-hover:text-orange-600 font-bold transition">3440000348</p>
                                    <p class="text-xs text-slate-400 mt-1">a.n. Lazismu Madrasah Mu'allimin</p>
                                </div>
                                <button onclick="copyText('3440000348')" class="w-10 h-10 rounded-full bg-white text-slate-400 hover:text-orange-500 hover:shadow-md transition flex items-center justify-center"><i class="far fa-copy"></i></button>
                             </div>
                             <div class="p-5 rounded-2xl flex items-center justify-between bg-slate-50 hover:bg-white hover:shadow-md transition border border-slate-100 group">
                                <div>
                                    <div class="flex items-center gap-2 mb-1"><span class="font-bold text-slate-800">BSI</span> <span class="text-xs bg-slate-200 px-2 rounded text-slate-500">451</span></div>
                                    <p class="font-mono text-lg text-slate-600 group-hover:text-teal-600 font-bold transition">7930030303</p>
                                    <p class="text-xs text-slate-400 mt-1">a.n. Lazismu Muallimin</p>
                                </div>
                                <button onclick="copyText('7930030303')" class="w-10 h-10 rounded-full bg-white text-slate-400 hover:text-teal-500 hover:shadow-md transition flex items-center justify-center"><i class="far fa-copy"></i></button>
                             </div>
                             <div class="p-5 rounded-2xl flex items-center justify-between bg-slate-50 hover:bg-white hover:shadow-md transition border border-slate-100 group">
                                <div>
                                    <div class="flex items-center gap-2 mb-1"><span class="font-bold text-slate-800">BPD DIY Syariah</span> <span class="text-xs bg-slate-200 px-2 rounded text-slate-500">112</span></div>
                                    <p class="font-mono text-lg text-slate-600 group-hover:text-blue-600 font-bold transition">801241004624</p>
                                    <p class="text-xs text-slate-400 mt-1">a.n. KL Lazismu Madrasah</p>
                                </div>
                                <button onclick="copyText('801241004624')" class="w-10 h-10 rounded-full bg-white text-slate-400 hover:text-blue-500 hover:shadow-md transition flex items-center justify-center"><i class="far fa-copy"></i></button>
                             </div>
                        </div>
                    </div>
                </div>
             </section>
        </section>

        <!-- === NEW: BERITA SECTION (INTEGRATED) === -->
        <section id="page-berita" class="page-section bg-white min-h-screen py-20">
            <div class="container mx-auto px-4 md:px-6">
                <!-- Header -->
                <div class="text-center mb-12">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-50 text-blue-600 text-2xl mb-4 shadow-glow">
                        <i class="fas fa-newspaper"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-slate-800 mb-2">Kabar Lazismu</h2>
                    <p class="text-slate-500">Informasi terkini kegiatan dan penyaluran.</p>
                </div>

                <!-- Controls (Search & Filter) -->
                <div class="bg-white p-4 rounded-xl shadow-soft border border-slate-100 mb-8 flex flex-col md:flex-row gap-4 justify-between items-center sticky top-20 z-30 opacity-95 backdrop-blur">
                    <div id="news-filter-container" class="flex gap-2 overflow-x-auto w-full md:w-auto pb-2 md:pb-0">
                        <!-- Default Button: Semua -->
                        <button data-slug="" onclick="filterNews('')" class="news-filter-btn active bg-brand-orange text-white px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition">Semua</button>
                        
                        <!-- Skeleton Loading State -->
                        <div class="animate-pulse bg-slate-100 h-9 w-20 rounded-lg"></div>
                        <div class="animate-pulse bg-slate-100 h-9 w-20 rounded-lg"></div>
                    </div>
                    <div class="relative w-full md:w-72">
                        <input type="text" id="news-search-input" placeholder="Cari berita..." 
                            class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-brand-orange transition"
                            onkeypress="handleNewsSearch(event)">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>

                <!-- News Grid -->
                <div id="news-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Content Injected by JS -->
                    <div class="col-span-full text-center py-12">
                        <div class="animate-spin inline-block w-8 h-8 border-4 border-slate-200 border-t-orange-500 rounded-full mb-4"></div>
                        <p class="text-slate-400">Memuat berita...</p>
                    </div>
                </div>

                <!-- Load More -->
                <div class="text-center mt-10">
                    <button id="btn-news-load-more" onclick="loadMoreNews()" class="hidden bg-white border border-gray-300 text-gray-700 px-6 py-3 rounded-full font-semibold hover:bg-gray-50 hover:text-brand-orange hover:border-orange-500 transition shadow-sm">
                        Muat Lebih Banyak <i class="fas fa-sync-alt ml-2"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- === RIWAYAT SECTION (UPGRADED) === -->
        <section id="page-riwayat" class="page-section bg-white min-h-screen py-20">
             <div class="container mx-auto px-4 md:px-6">
                 <div class="text-center mb-12">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-purple-50 text-purple-600 text-2xl mb-4 shadow-glow">
                        <i class="fas fa-history"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-slate-800 mb-2">Jejak Kebaikan</h2>
                    <p class="text-slate-500">Transparansi kebaikan adalah prioritas kami.</p>
                </div>
                
                <!-- Stats Row 1 (General) -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="soft-card p-5 flex items-center gap-4 border-l-4 border-blue-500">
                         <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-xl shrink-0"><i class="fas fa-chart-line"></i></div>
                        <div><p class="text-xs text-slate-400 font-bold uppercase">Total Himpunan</p><h3 id="stat-r-total" class="text-lg font-black text-slate-800">Rp 0</h3></div>
                    </div>
                    <div class="soft-card p-5 flex items-center gap-4 border-l-4 border-purple-500">
                         <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 text-xl shrink-0"><i class="fas fa-receipt"></i></div>
                        <div><p class="text-xs text-slate-400 font-bold uppercase">Total Transaksi</p><h3 id="stat-r-transaksi" class="text-lg font-black text-slate-800">0</h3></div>
                    </div>
                    <div class="soft-card p-5 flex items-center gap-4 border-l-4 border-green-500">
                         <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-xl shrink-0"><i class="fas fa-calendar-day"></i></div>
                        <div><p class="text-xs text-slate-400 font-bold uppercase">Himpunan Hari Ini</p><h3 id="stat-r-hari-ini" class="text-lg font-black text-slate-800">Rp 0</h3></div>
                    </div>
                     <div class="soft-card p-5 flex items-center gap-4 border-l-4 border-teal-500">
                         <div class="w-12 h-12 bg-teal-100 rounded-full flex items-center justify-center text-teal-600 text-xl shrink-0"><i class="fas fa-star"></i></div>
                        <div><p class="text-xs text-slate-400 font-bold uppercase">Donasi Terpopuler</p><h3 id="stat-r-tipe-top" class="text-sm font-bold text-slate-800 truncate w-32">Memuat...</h3></div>
                    </div>
                </div>

                <!-- Stats Row 2 (Breakdown by Type) -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                    <div class="bg-emerald-50 rounded-2xl p-4 flex justify-between items-center border border-emerald-100">
                        <div><p class="text-xs font-bold text-emerald-600 uppercase">Zakat Fitrah</p><h4 id="stat-detail-fitrah" class="text-lg font-black text-slate-700">Rp 0</h4></div>
                        <i class="fas fa-leaf text-emerald-200 text-3xl"></i>
                    </div>
                    <div class="bg-yellow-50 rounded-2xl p-4 flex justify-between items-center border border-yellow-100">
                        <div><p class="text-xs font-bold text-yellow-600 uppercase">Zakat Maal</p><h4 id="stat-detail-maal" class="text-lg font-black text-slate-700">Rp 0</h4></div>
                        <i class="fas fa-coins text-yellow-200 text-3xl"></i>
                    </div>
                    <div class="bg-orange-50 rounded-2xl p-4 flex justify-between items-center border border-orange-100">
                        <div><p class="text-xs font-bold text-orange-600 uppercase">Total Infaq</p><h4 id="stat-detail-infaq" class="text-lg font-black text-slate-700">Rp 0</h4></div>
                        <i class="fas fa-hand-holding-heart text-orange-200 text-3xl"></i>
                    </div>
                </div>

                <!-- Filter -->
                <div class="bg-white shadow-soft rounded-2xl p-6 mb-8 border border-slate-50">
                     <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <select id="filter-jenis" class="input-soft p-3 rounded-xl text-sm text-slate-600 font-bold cursor-pointer w-full">
                            <option value="all">Semua Jenis</option>
                            <option value="Zakat Fitrah">Zakat Fitrah</option>
                            <option value="Zakat Maal">Zakat Maal</option>
                            <option value="Infaq Pengembangan Kampus">Infaq Kampus</option>
                            <option value="Infaq Beasiswa Pendidikan">Infaq Beasiswa</option>
                            <option value="Infaq Umum">Infaq Umum</option>
                        </select>
                         <select id="filter-metode" class="input-soft p-3 rounded-xl text-sm text-slate-600 font-bold cursor-pointer w-full">
                            <option value="all">Semua Metode</option>
                            <option value="QRIS">QRIS</option>
                            <option value="Transfer">Transfer</option>
                            <option value="Tunai">Tunai</option>
                        </select>
                        <div class="md:col-span-2 flex gap-2 overflow-x-auto pb-2 md:pb-0">
                            <button class="time-filter-btn px-4 py-2 rounded-xl bg-slate-100 text-slate-500 hover:bg-slate-200 text-xs font-bold transition whitespace-nowrap" data-time="today">Hari Ini</button>
                            <button class="time-filter-btn px-4 py-2 rounded-xl bg-slate-100 text-slate-500 hover:bg-slate-200 text-xs font-bold transition whitespace-nowrap" data-time="week">Pekan Ini</button>
                            <button class="time-filter-btn px-4 py-2 rounded-xl bg-slate-100 text-slate-500 hover:bg-slate-200 text-xs font-bold transition whitespace-nowrap" data-time="month">Bulan Ini</button>
                            <button class="time-filter-btn px-4 py-2 rounded-xl bg-slate-100 text-slate-500 hover:bg-slate-200 text-xs font-bold transition whitespace-nowrap" data-time="year">Tahun Ini</button>
                            <button id="btn-reset-filter" class="px-4 py-2 rounded-xl bg-red-50 text-red-500 hover:bg-red-100 text-xs font-bold transition whitespace-nowrap ml-auto"><i class="fas fa-undo mr-1"></i> Reset</button>
                        </div>
                        <input type="hidden" id="filter-start-date">
                        <input type="hidden" id="filter-end-date">
                     </div>
                </div>

                <!-- List -->
                <div class="max-w-4xl mx-auto">
                    <div id="riwayat-loading" class="py-20 text-center">
                        <div class="inline-block w-10 h-10 border-4 border-slate-200 border-t-orange-500 rounded-full animate-spin mb-4"></div>
                        <p class="text-slate-500 font-medium">Mengambil data...</p>
                    </div>
                    <div id="riwayat-content" class="hidden space-y-4">
                        <div id="riwayat-list-container" class="space-y-3"></div>
                        <div class="flex justify-between items-center pt-8 border-t border-slate-100 mt-6">
                            <button id="riwayat-prev" class="px-4 py-2 rounded-lg bg-white border border-slate-200 text-slate-600 font-bold text-sm hover:bg-slate-50 disabled:opacity-50">Prev</button>
                            <span id="riwayat-page-info" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Page 1</span>
                            <button id="riwayat-next" class="px-4 py-2 rounded-lg bg-white border border-slate-200 text-slate-600 font-bold text-sm hover:bg-slate-50 disabled:opacity-50">Next</button>
                        </div>
                    </div>
                    <div id="riwayat-no-data" class="hidden py-20 text-center text-slate-400"><i class="far fa-folder-open text-3xl mb-2"></i><p>Data tidak ditemukan.</p></div>
                </div>
             </div>
        </section>
        
        <!-- === REKAPITULASI SECTION === -->
        <section id="page-rekapitulasi" class="page-section bg-white min-h-screen py-20">
             <div class="container mx-auto px-4 md:px-6">
                <div class="text-center mb-12">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-teal-50 text-teal-600 text-2xl mb-4 shadow-glow">
                        <i class="fas fa-table"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-slate-800 mb-2">Rekapitulasi Kelas</h2>
                    <p class="text-slate-500">Data transparan perolehan kelas.</p>
                </div>

                <div class="max-w-5xl mx-auto">
                    <!-- Filter Control -->
                    <div class="bg-white p-8 rounded-3xl shadow-soft mb-8 flex flex-col md:flex-row gap-6 items-start justify-between">
                        <div class="w-full md:w-2/3 grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">1. Pilih Tingkat</label>
                                <select id="rekap-level-select" class="w-full p-4 rounded-xl input-soft font-bold text-slate-700 cursor-pointer">
                                    <option value="">-- Tingkat --</option>
                                    <option value="1">Kelas 1</option>
                                    <option value="2">Kelas 2</option>
                                    <option value="3">Kelas 3</option>
                                    <option value="4">Kelas 4</option>
                                    <option value="5">Kelas 5</option>
                                    <option value="6">Kelas 6</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">2. Pilih Kelas</label>
                                <select id="rekap-kelas-select" class="w-full p-4 rounded-xl input-soft font-bold text-slate-700 cursor-pointer" disabled>
                                    <option value="">-- Kelas --</option>
                                </select>
                            </div>
                        </div>
                         <div class="w-full md:w-auto pt-6">
                            <button id="btn-export-pdf" disabled class="w-full md:w-auto px-6 py-4 bg-red-50 text-red-600 rounded-xl font-bold hover:bg-red-100 transition disabled:opacity-50 flex items-center justify-center gap-2 transform active:scale-95">
                                <i class="fas fa-file-pdf"></i> Unduh PDF
                            </button>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div id="rekap-summary" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 animate-fade-in-up">
                        <div class="soft-card p-6 border-l-4 border-indigo-500">
                            <p class="text-xs font-bold text-indigo-500 uppercase mb-1">Wali Kelas</p>
                            <h4 id="rekap-wali" class="text-lg font-bold text-slate-800">-</h4>
                        </div>
                        <div class="soft-card p-6 border-l-4 border-teal-500">
                             <p class="text-xs font-bold text-teal-500 uppercase mb-1">Musyrif</p>
                            <h4 id="rekap-musyrif" class="text-lg font-bold text-slate-800">-</h4>
                        </div>
                        <div class="bg-orange-500 p-6 rounded-2xl text-white shadow-lg shadow-orange-500/20">
                            <p class="text-xs font-bold text-orange-100 uppercase mb-1">Total Perolehan</p>
                            <h4 id="rekap-total-kelas" class="text-3xl font-black">Rp 0</h4>
                        </div>
                    </div>

                    <!-- Table Container -->
                    <div id="rekap-table-container" class="hidden bg-white rounded-3xl shadow-soft overflow-hidden animate-fade-in-up">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-slate-600">
                                <thead class="bg-slate-50 text-slate-700 font-bold uppercase text-xs tracking-wider">
                                    <tr>
                                        <th class="px-6 py-5">No</th>
                                        <th class="px-6 py-5">Nama Santri</th>
                                        <th class="px-6 py-5 text-right">QRIS</th>
                                        <th class="px-6 py-5 text-right">Transfer</th>
                                        <th class="px-6 py-5 text-right">Tunai</th>
                                        <th class="px-6 py-5 text-right bg-orange-50 text-orange-700">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="rekap-table-body" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                    
                     <div id="rekap-placeholder" class="text-center py-24 bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200">
                        <i class="fas fa-chart-bar text-4xl text-slate-300 mb-4"></i>
                        <p class="text-slate-400 font-bold">Pilih tingkat dan kelas untuk melihat data.</p>
                    </div>
                </div>
        </section>

        <!-- === DONASI WIZARD SECTION === -->
        <section id="page-donasi" class="page-section bg-white py-20">
             <div class="container mx-auto px-4 md:px-6">
                  <div class="max-w-2xl mx-auto mb-10 text-center">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-orange-100 text-orange-600 text-2xl mb-4 shadow-glow">
                        <i class="fas fa-hand-holding-heart"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-slate-800 mb-3">Formulir Kebaikan</h2>
                    <p class="text-slate-500">5 Langkah mudah menebar manfaat.</p>
                </div>
                <div id="donasi-wizard" class="max-w-3xl mx-auto bg-white rounded-3xl shadow-soft overflow-hidden relative">
                    <div class="h-1.5 bg-slate-100 w-full"><div id="wizard-progress-bar" class="h-full bg-brand-orange transition-all duration-500 ease-out" style="width: 20%"></div></div>
                    <div class="px-8 pt-8 pb-4 flex justify-between items-center border-b border-slate-50">
                        <div>
                            <h3 id="wizard-title" class="text-xl font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-hand-pointer text-orange-500"></i> Pilih Jenis</h3>
                            <p id="wizard-subtitle" class="text-sm text-slate-500 mt-1">Niat Suci Dimulai</p>
                        </div>
                        <span id="wizard-step-indicator" class="text-xs font-bold text-orange-500 bg-orange-50 px-3 py-1 rounded-full">Step 1/5</span>
                    </div>
                    <div class="p-6 md:p-10 min-h-[400px]">
                        <!-- STEP 1 -->
                         <div id="donasi-step-1" class="donasi-step-container">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <button data-type="Zakat Fitrah" class="choice-button selection-btn soft-card p-6 flex flex-col items-center justify-center gap-3 type-fitrah group">
                                    <i class="fas fa-leaf text-3xl text-emerald-500 group-hover:scale-110 transition-transform"></i>
                                    <span class="font-bold text-slate-700">Zakat Fitrah</span>
                                    <p class="text-[10px] text-emerald-600 font-medium">Pembersih jiwa di bulan Ramadhan</p>
                                </button>
                                <button data-type="Zakat Maal" class="choice-button selection-btn soft-card p-6 flex flex-col items-center justify-center gap-3 type-maal group">
                                    <i class="fas fa-coins text-3xl text-yellow-500 group-hover:scale-110 transition-transform"></i>
                                    <span class="font-bold text-slate-700">Zakat Maal</span>
                                    <p class="text-[10px] text-yellow-600 font-medium">Membersihkan harta, memberkahi rezeki</p>
                                </button>
                                <button data-type="Infaq" class="choice-button selection-btn soft-card p-6 flex flex-col items-center justify-center gap-3 type-infaq group">
                                    <i class="fas fa-hand-holding-heart text-3xl text-orange-500 group-hover:scale-110 transition-transform"></i>
                                    <span class="font-bold text-slate-700">Infaq</span>
                                    <p class="text-[10px] text-orange-600 font-medium">Sedekah jariyah untuk kemaslahatan</p>
                                </button>
                            </div>
                             <div id="infaq-options" class="hidden space-y-3">
                                <p class="text-xs font-bold text-slate-400 uppercase mb-2">Pilih Peruntukan Infaq</p>
                                <button data-type-infaq="Infaq Pengembangan Kampus" class="sub-choice-button selection-btn w-full p-4 rounded-xl bg-slate-50 flex items-center gap-4 text-left cursor-pointer hover:bg-white hover:shadow-md transition"><div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center text-orange-600"><i class="fas fa-building"></i></div><div><span class="font-bold text-slate-700 block">Pengembangan Kampus</span><span class="text-xs text-slate-500">Wakaf pembangunan sarana pendidikan</span></div></button>
                                <button data-type-infaq="Infaq Beasiswa Pendidikan" class="sub-choice-button selection-btn w-full p-4 rounded-xl bg-slate-50 flex items-center gap-4 text-left cursor-pointer hover:bg-white hover:shadow-md transition"><div class="w-10 h-10 rounded-full bg-cyan-100 flex items-center justify-center text-cyan-600"><i class="fas fa-user-graduate"></i></div><div><span class="font-bold text-slate-700 block">Beasiswa Pendidikan</span><span class="text-xs text-slate-500">Bantuan santri berprestasi & dhuafa</span></div></button>
                                <button data-type-infaq="Infaq Umum" class="sub-choice-button selection-btn w-full p-4 rounded-xl bg-slate-50 flex items-center gap-4 text-left cursor-pointer hover:bg-white hover:shadow-md transition"><div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600"><i class="fas fa-globe"></i></div><div><span class="font-bold text-slate-700 block">Infaq Umum</span><span class="text-xs text-slate-500">Dana operasional & program sosial</span></div></button>
                            </div>
                             <div id="zakat-fitrah-checker" class="hidden bg-emerald-50 p-6 rounded-2xl border border-emerald-100 animate-fade-in-up"><p class="text-emerald-800 text-sm mb-4 font-bold"><i class="fas fa-info-circle mr-2"></i>Besaran Zakat Fitrah: <strong>Rp 37.500</strong> / jiwa.</p><div class="flex gap-4"><input type="number" id="fitrah-jumlah-orang" class="w-full p-3 rounded-xl border-0 bg-white shadow-sm focus:ring-2 focus:ring-emerald-500" placeholder="Jumlah Jiwa"><input type="text" id="fitrah-total" class="w-full p-3 rounded-xl bg-emerald-100 font-bold text-emerald-800 text-center border-transparent" value="Rp 0" readonly></div><button id="btn-fitrah-next" class="mt-4 w-full bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700 transition shadow-lg shadow-emerald-500/20">Lanjut Data Diri <i class="fas fa-arrow-right ml-2"></i></button></div>
                            <div id="zakat-maal-checker" class="hidden bg-yellow-50 p-6 rounded-2xl border border-yellow-100 animate-fade-in-up"><div class="space-y-3"><div class="relative"><label class="text-[10px] font-bold text-yellow-700 uppercase mb-1 ml-1">Harga Emas (per gram)</label><input type="text" id="harga-emas" class="w-full p-3 rounded-xl bg-white shadow-sm focus:ring-2 focus:ring-yellow-500" value="Rp 1.300.000"></div><div class="relative"><label class="text-[10px] font-bold text-yellow-700 uppercase mb-1 ml-1">Penghasilan Bulanan</label><input type="text" id="penghasilan-bulanan" class="w-full p-3 rounded-xl bg-white shadow-sm focus:ring-2 focus:ring-yellow-500" placeholder="Contoh: 5.000.000"></div><button id="zakat-check-button" class="w-full bg-yellow-500 text-white py-3 rounded-xl font-bold hover:bg-yellow-600 transition shadow-lg shadow-yellow-500/20">Hitung Zakat</button></div><div id="zakat-result" class="hidden mt-4 pt-4 border-t border-yellow-200 text-center"><p id="zakat-result-message" class="font-bold text-lg mb-3"></p><button id="btn-maal-next" class="hidden w-full bg-yellow-600 text-white py-3 rounded-xl font-bold hover:bg-yellow-700 transition">Bayar Zakat <i class="fas fa-arrow-right ml-2"></i></button><button id="zakat-lanjutkan-infaq" class="hidden w-full mt-2 text-yellow-700 font-bold hover:bg-yellow-100 py-2 rounded-lg transition">Tidak Wajib, Lanjut Infaq Saja</button></div></div>
                            <div id="step-1-nav-default" class="hidden mt-8 flex justify-end"><button data-next-step="2" class="bg-brand-orange text-white px-8 py-3 rounded-full font-bold hover:bg-orange-600 transition shadow-lg transform active:scale-95">Lanjut <i class="fas fa-arrow-right ml-2"></i></button></div>
                        </div>
                        <!-- STEP 2 -->
                        <div id="donasi-step-2" class="donasi-step-container hidden"><div class="grid grid-cols-2 gap-3 mb-6"><button class="nominal-btn selection-btn bg-slate-50 rounded-xl p-4 font-bold text-slate-600 hover:bg-white hover:shadow-md transition" data-nominal="50000">Rp 50.000</button><button class="nominal-btn selection-btn bg-slate-50 rounded-xl p-4 font-bold text-slate-600 hover:bg-white hover:shadow-md transition" data-nominal="100000">Rp 100.000</button><button class="nominal-btn selection-btn bg-slate-50 rounded-xl p-4 font-bold text-slate-600 hover:bg-white hover:shadow-md transition" data-nominal="250000">Rp 250.000</button><button class="nominal-btn selection-btn bg-slate-50 rounded-xl p-4 font-bold text-slate-600 hover:bg-white hover:shadow-md transition" data-nominal="500000">Rp 500.000</button><button class="nominal-btn selection-btn bg-slate-50 rounded-xl p-4 font-bold text-slate-600 hover:bg-white hover:shadow-md transition" data-nominal="1000000">Rp 1.000.000</button><button class="nominal-btn selection-btn bg-slate-50 rounded-xl p-4 font-bold text-slate-600 hover:bg-white hover:shadow-md transition" data-nominal="2000000">Rp 2.000.000</button></div><div class="mb-8"><label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Nominal Lainnya</label><input type="text" id="nominal-custom" class="w-full p-4 rounded-xl input-soft text-xl font-bold text-slate-800" placeholder="Rp 0"></div><div class="flex justify-between"><button data-prev-step="1" class="text-slate-400 hover:text-slate-600 font-bold px-4">Kembali</button><button data-next-step="3" class="bg-brand-orange text-white px-8 py-3 rounded-full font-bold hover:bg-orange-600 transition shadow-lg transform active:scale-95">Lanjut <i class="fas fa-arrow-right ml-2"></i></button></div></div>
                        <!-- STEP 3 -->
                        <div id="donasi-step-3" class="donasi-step-container hidden"><div class="space-y-5"><div class="bg-slate-100 p-1 rounded-xl flex flex-row font-bold text-slate-500 gap-1"><label class="flex-1 text-center cursor-pointer"><input type="radio" name="donatur-tipe" value="santri" class="hidden peer" checked><span class="block py-3 rounded-lg peer-checked:bg-white peer-checked:text-orange-500 peer-checked:shadow-sm transition">Via Santri</span></label><label class="flex-1 text-center cursor-pointer"><input type="radio" name="donatur-tipe" value="umum" class="hidden peer"><span class="block py-3 rounded-lg peer-checked:bg-white peer-checked:text-orange-500 peer-checked:shadow-sm transition">Masyarakat Umum</span></label></div><div id="santri-details" class="bg-orange-50 p-5 rounded-2xl border border-orange-100 space-y-3 animate-fade-in-up"><h5 class="text-orange-800 font-bold text-sm"><i class="fas fa-child mr-2"></i> Data Santri</h5><div class="grid grid-cols-2 gap-3"><select id="santri-level-select" class="w-full p-2.5 rounded-lg border-0 bg-white cursor-pointer text-sm"><option value="">Tingkat</option><option value="1">Kelas 1</option><option value="2">Kelas 2</option><option value="3">Kelas 3</option><option value="4">Kelas 4</option><option value="5">Kelas 5</option><option value="6">Kelas 6</option></select><select id="santri-rombel-select" class="w-full p-2.5 rounded-lg border-0 bg-white cursor-pointer text-sm" disabled><option value="">Rombel</option></select></div><select id="santri-nama-select" class="w-full p-2.5 rounded-lg border-0 bg-white cursor-pointer text-sm" disabled><option value="">Pilih Nama Santri</option></select></div><div><label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Nama Donatur</label><input type="text" id="nama-muzakki-input" class="w-full p-3 rounded-xl input-soft font-bold" placeholder="Nama Lengkap Anda" required><div id="div-check-alumni" class="mt-2"><label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="check-also-alumni" class="text-orange-500 rounded focus:ring-orange-500"><span class="text-sm font-medium text-slate-500">Saya juga Alumni</span></label></div><div id="input-alumni-tahun" class="hidden mt-2"><input type="number" id="alumni-tahun" class="w-full p-3 rounded-xl input-soft text-sm" placeholder="Tahun Lulus (Contoh: 1998)"></div><div class="flex gap-4 mt-3 text-sm"><label class="flex items-center gap-2"><input type="radio" name="nama-choice" value="manual" class="text-orange-500" checked> Manual</label><label class="flex items-center gap-2"><input type="radio" name="nama-choice" value="santri" id="radio-an-santri" class="text-orange-500" disabled> A/n Santri</label><label class="flex items-center gap-2"><input type="radio" name="nama-choice" value="hamba" class="text-orange-500"> Hamba Allah</label></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="text-xs font-bold text-slate-400 uppercase mb-1 block">WhatsApp (Wajib)</label><input type="tel" id="no-hp" class="w-full p-3 rounded-xl input-soft" placeholder="08..." required></div><div><label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Email</label><input type="email" id="email" class="w-full p-3 rounded-xl input-soft" placeholder="Opsional"></div></div><div><label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Alamat Lengkap (Wajib)</label><textarea id="alamat" rows="2" class="w-full p-3 rounded-xl input-soft" placeholder="Alamat domisili saat ini" required></textarea></div><div><label class="text-xs font-bold text-slate-400 uppercase mb-1 block">No. KTP / NIK (Opsional)</label><input type="text" id="no-ktp" class="w-full p-3 rounded-xl input-soft" placeholder="16 digit NIK"></div><div><label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Pesan dan Doa (Opsional)</label><textarea id="pesan-doa" rows="2" class="w-full p-3 rounded-xl input-soft" placeholder="Tuliskan doa atau pesan kebaikan Anda..."></textarea></div></div><div class="flex justify-between mt-8"><button data-prev-step="2" class="text-slate-400 hover:text-slate-600 font-bold px-4">Kembali</button><button data-next-step="4" class="bg-brand-orange text-white px-8 py-3 rounded-full font-bold hover:bg-orange-600 transition shadow-lg transform active:scale-95">Lanjut <i class="fas fa-arrow-right ml-2"></i></button></div></div>
                        <!-- STEP 4 -->
                        <div id="donasi-step-4" class="donasi-step-container hidden"><div class="space-y-3">
                            <label class="relative flex items-center gap-4 p-5 rounded-2xl bg-slate-50 cursor-pointer hover:bg-white hover:shadow-md transition border-2 border-transparent has-[:checked]:border-orange-500 has-[:checked]:bg-orange-50">
                                <input type="radio" name="payment-method" value="QRIS" class="peer sr-only">
                                <div class="w-12 h-12 rounded-full bg-white text-slate-600 flex items-center justify-center text-xl shadow-sm peer-checked:bg-brand-orange peer-checked:text-white transition-colors"><i class="fas fa-qrcode"></i></div>
                                <div><h5 class="font-bold text-slate-800 peer-checked:text-orange-800">QRIS</h5><p class="text-xs text-slate-500 peer-checked:text-orange-700">Gopay, OVO, Dana, M-Banking</p></div>
                                <div class="absolute top-4 right-4 text-orange-500 opacity-0 peer-checked:opacity-100 transition-opacity"><i class="fas fa-check-circle text-xl"></i></div>
                            </label>
                            <label class="relative flex items-center gap-4 p-5 rounded-2xl bg-slate-50 cursor-pointer hover:bg-white hover:shadow-md transition border-2 border-transparent has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                                <input type="radio" name="payment-method" value="Transfer" class="peer sr-only">
                                <div class="w-12 h-12 rounded-full bg-white text-slate-600 flex items-center justify-center text-xl shadow-sm peer-checked:bg-blue-500 peer-checked:text-white transition-colors"><i class="fas fa-university"></i></div>
                                <div><h5 class="font-bold text-slate-800 peer-checked:text-blue-800">Transfer Bank</h5><p class="text-xs text-slate-500 peer-checked:text-blue-700">BSI, BNI, BPD DIY Syariah</p></div>
                                <div class="absolute top-4 right-4 text-blue-500 opacity-0 peer-checked:opacity-100 transition-opacity"><i class="fas fa-check-circle text-xl"></i></div>
                            </label>
                            <label class="relative flex items-center gap-4 p-5 rounded-2xl bg-slate-50 cursor-pointer hover:bg-white hover:shadow-md transition border-2 border-transparent has-[:checked]:border-teal-500 has-[:checked]:bg-teal-50">
                                <input type="radio" name="payment-method" value="Tunai" class="peer sr-only">
                                <div class="w-12 h-12 rounded-full bg-white text-slate-600 flex items-center justify-center text-xl shadow-sm peer-checked:bg-teal-500 peer-checked:text-white transition-colors"><i class="fas fa-money-bill-wave"></i></div>
                                <div><h5 class="font-bold text-slate-800 peer-checked:text-teal-800">Tunai (Cash)</h5><p class="text-xs text-slate-500 peer-checked:text-teal-700">Serahkan ke Kantor Layanan</p></div>
                                <div class="absolute top-4 right-4 text-teal-500 opacity-0 peer-checked:opacity-100 transition-opacity"><i class="fas fa-check-circle text-xl"></i></div>
                            </label>
                        </div><div class="flex justify-between mt-8"><button data-prev-step="3" class="text-slate-400 hover:text-slate-600 font-bold px-4">Kembali</button><button data-next-step="5" class="bg-brand-orange text-white px-8 py-3 rounded-full font-bold hover:bg-orange-600 transition shadow-lg transform active:scale-95">Lanjut <i class="fas fa-arrow-right ml-2"></i></button></div></div>
                        <!-- STEP 5 -->
                        <div id="donasi-step-5" class="donasi-step-container hidden"><div class="bg-slate-50 rounded-2xl p-6 mb-6"><div class="flex justify-between items-start mb-4 pb-4 border-b border-slate-200"><div><p class="text-xs text-slate-400 font-bold uppercase">Jenis</p><h4 id="summary-type" class="text-lg font-bold text-slate-800">Zakat Maal</h4></div><div class="text-right"><p class="text-xs text-slate-400 font-bold uppercase">Nominal</p><h4 id="summary-nominal" class="text-2xl font-black text-orange-500">Rp 0</h4></div></div><div class="space-y-2 text-sm"><div class="flex justify-between"><span class="text-slate-500">Nama:</span> <span id="summary-nama" class="font-bold text-slate-800"></span></div><div class="flex justify-between"><span class="text-slate-500">WA:</span> <span id="summary-hp" class="font-bold text-slate-800"></span></div><div class="flex justify-between"><span class="text-slate-500">Metode:</span> <span id="summary-metode" class="font-bold text-slate-800"></span></div><div id="summary-santri-row" class="flex justify-between hidden"><span class="text-slate-500">Santri:</span> <span id="summary-santri" class="font-bold text-slate-800 text-right max-w-[60%]"></span></div></div></div><label class="flex items-start gap-3 p-4 rounded-xl bg-orange-50 cursor-pointer hover:bg-orange-100 transition mb-4"><input type="checkbox" id="confirm-check" class="mt-1 w-5 h-5 text-orange-500 rounded focus:ring-orange-500"><span class="text-sm text-orange-900 font-bold leading-snug">Data benar & saya berniat donasi lillahi ta'ala.</span></label><p class="text-[10px] text-slate-400 leading-relaxed mb-8 px-2 text-justify">Dengan mengisi formulir ini, Muzaki menyatakan bahwa zakat yang ditunaikan berasal dari sumber halal yang sesuai dengan peraturan, bukan hasil pencucian uang, dan merupakan harta yang dimiliki secara penuh.</p><div class="flex justify-between"><button data-prev-step="4" class="text-slate-400 hover:text-slate-600 font-bold px-4">Kembali</button><button id="btn-submit-final" class="bg-brand-orange text-white px-8 py-3 rounded-full font-bold hover:bg-orange-600 transition shadow-lg shadow-orange-500/30 flex items-center gap-2 transform active:scale-95"><span class="default-text">Bayar Sekarang <i class="fas fa-check-circle"></i></span><span class="loading-text hidden"><i class="fas fa-spinner fa-spin"></i> Proses...</span></button></div></div>
                    </div>
                </div>
                <!-- FINAL PAYMENT INSTRUCTION -->
                <div id="donasi-payment-instructions" class="hidden max-w-3xl mx-auto animate-fade-in-up"><div class="bg-white rounded-3xl shadow-soft overflow-hidden text-center p-10"><div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl text-green-600 animate-bounce"><i class="fas fa-check"></i></div><h2 class="text-3xl font-bold text-slate-800 mb-2">Instruksi Pembayaran</h2><p class="text-slate-500 mb-8">Silakan selesaikan pembayaran Anda.</p><div id="instruction-content" class="mb-10 text-left bg-slate-50 p-6 rounded-2xl border border-slate-100"></div><div class="flex flex-col sm:flex-row gap-4 justify-center"><a id="btn-wa-confirm" href="#" target="_blank" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-4 rounded-2xl font-bold text-lg transition hover:from-green-600 hover:to-green-700 shadow-lg shadow-green-500/20 transform hover:-translate-y-1 flex items-center justify-center gap-3 group"><div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center group-hover:rotate-12 transition"><i class="fab fa-whatsapp text-2xl"></i></div><div class="text-left"><span class="block text-xs font-medium opacity-80">Langkah Terakhir</span><span class="block leading-none">Konfirmasi WA</span></div></a><button onclick="location.reload()" class="flex-1 inline-block bg-white text-slate-600 px-8 py-4 rounded-2xl font-bold text-lg transition hover:bg-slate-50 shadow-sm border border-slate-200 hover:border-orange-300 hover:text-orange-600 flex items-center justify-center gap-3 group"><div class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center group-hover:bg-orange-100 transition"><i class="fas fa-plus text-slate-400 group-hover:text-orange-500"></i></div><div class="text-left"><span class="block text-xs font-medium opacity-60">Ingin donasi lagi?</span><span class="block leading-none">Donasi Baru</span></div></button></div></div></div>
            </div>
        </section>
    </main>

    <script>
        // --- CONFIGURATION ---
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbydrhNmtJEk-lHLfrAzI8dG_uOZEKk72edPAEeL9pzVCna6br_hY2dAqDr-t8V5ost4/exec";
        const WORDPRESS_SITE = 'lazismumuallimin.wordpress.com'; 
        const NEWS_PER_PAGE = 6;

        // --- STATE MANAGEMENT ---
        let donasiData = {
            type: null, 
            subType: null, 
            nominal: 0,
            donaturTipe: 'santri', 
            isAlumni: false, 
            alumniTahun: '',
            namaSantri: '', nisSantri: '', rombelSantri: '',
            nama: '', hp: '', email: '', alamat: '', doa: '',
            metode: null
        };
        let riwayatData = { allData: [], isLoaded: false, currentPage: 1, itemsPerPage: 10 };
        let timeFilterState = 'all';
        
        // NEW: News State
        let newsState = {
            page: 1,
            category: '',
            search: '',
            posts: [],
            isLoading: false,
            hasMore: true,
            isLoaded: false // Prevent re-fetching on tab switch
        };

        document.addEventListener('DOMContentLoaded', () => {
            init();
        });

        function init() {
            parseSantriData();
            setupNavigation();
            setupWizardLogic();
            setupHistoryLogic();
            setupModalLogic();
            setupRekapLogic();
            handleInitialLoad();
            fetchNewsCategories(); 
        }

        // --- TOAST NOTIFICATION SYSTEM ---
        function showToast(message, type = 'warning') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'fa-exclamation-triangle text-orange-500';
            if (type === 'success') icon = 'fa-check-circle text-green-500';
            if (type === 'error') icon = 'fa-times-circle text-red-500';

            toast.innerHTML = `<i class="fas ${icon} text-xl"></i><span class="font-bold text-sm text-slate-700">${message}</span>`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-out forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- UTILS ---
        function copyText(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast(`Berhasil disalin: ${text}`, 'success');
                }).catch(() => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast(`Berhasil disalin: ${text}`, 'success');
            } catch (err) {
                showToast('Gagal menyalin text', 'error');
            }
            document.body.removeChild(textArea);
        }

        function formatRupiah(num) {
            return "Rp " + parseInt(num).toLocaleString('id-ID');
        }

        function timeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " thn lalu";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " bln lalu";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " hr lalu";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " jam lalu";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " mnt lalu";
            return "Baru saja";
        }

        function animateValue(obj, start, end, duration, isCurrency = false) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const val = Math.floor(progress * (end - start) + start);
                obj.innerHTML = isCurrency ? formatRupiah(val) : val;
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        // --- SANTRI DATA PARSING ---
        let santriDB = {};
        function parseSantriData() {
            if (!rawSantriData) return;
            const lines = rawSantriData.trim().split('\n');
            lines.forEach(line => {
                const parts = line.split('\t');
                if (parts.length < 3) return;

                const rombel = parts[0].trim();
                const nis = parts[1].trim();
                const nama = parts[2].trim();
                const level = rombel.charAt(0);

                if (!santriDB[level]) santriDB[level] = {};
                if (!santriDB[level][rombel]) santriDB[level][rombel] = [];
                
                santriDB[level][rombel].push({ nama, nis, rombel });
            });
        }

        // --- NAVIGATION ---
        function showPage(pageId) {
            document.querySelectorAll('.page-section').forEach(p => {
                p.style.display = 'none';
                p.style.opacity = 0;
                p.classList.remove('active');
            });
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            
            const target = document.getElementById(`page-${pageId}`);
            if (target) {
                target.style.display = 'block';
                void target.offsetWidth; 
                target.style.opacity = 1;
                target.classList.add('active');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            
            const navLink = document.querySelector(`a[href="#${pageId}"]`);
            if (navLink) navLink.classList.add('active');

            // Logic khusus per halaman
            if (pageId === 'riwayat' || pageId === 'home') loadRiwayat();
            if (pageId === 'berita') {
                if(!newsState.isLoaded) fetchNews(); 
            }
        }
        
        function scrollToSection(sectionId) {
            showPage('home'); 
            setTimeout(() => {
                const el = document.getElementById(sectionId);
                if(el) el.scrollIntoView({behavior: 'smooth', block: 'start'});
            }, 500);
        }

        function handleInitialLoad() {
            const hash = window.location.hash.replace('#', '') || 'home';
            if (document.getElementById(`page-${hash}`)) {
                showPage(hash);
            } else {
                showPage('home');
            }
        }

        function setupNavigation() {
           const menuToggle = document.getElementById('menu-toggle');
           const menuLinks = document.getElementById('menu-links');
           if (menuToggle && menuLinks) {
               menuToggle.onclick = () => {
                   menuLinks.classList.toggle('hidden');
               };
           }
        }

        function setupModalLogic() {
            const modal = document.getElementById('hubungi-modal');
            const btn = document.getElementById('btn-hubungi-hero');
            const close = document.getElementById('hubungi-modal-close');

            if(btn) btn.onclick = () => modal.classList.remove('hidden');
            if(close) close.onclick = () => modal.classList.add('hidden');
            
            if(modal) {
                modal.onclick = (e) => {
                    if(e.target === modal) modal.classList.add('hidden');
                }
            }
        }

        // --- NEWS LOGIC (DYNAMIC CATEGORIES) ---
        async function fetchNewsCategories() {
            const container = document.getElementById('news-filter-container');
            if(!container) return;

            try {
                // Fetch categories from WordPress
                const res = await fetch(`https://public-api.wordpress.com/rest/v1.1/sites/${WORDPRESS_SITE}/categories`);
                const data = await res.json();
                
                // Start with "Semua" button
                let html = `<button data-slug="" onclick="filterNews('')" class="news-filter-btn active bg-brand-orange text-white px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition">Semua</button>`;
                
                if (data.categories) {
                    data.categories.forEach(cat => {
                        // Only show categories that have posts
                        if (cat.post_count > 0) {
                            html += `<button data-slug="${cat.slug}" onclick="filterNews('${cat.slug}')" class="news-filter-btn bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition">${cat.name}</button>`;
                        }
                    });
                }
                container.innerHTML = html;
            } catch (e) {
                console.error("Gagal ambil kategori", e);
                // Fallback to just "Semua" if fetch fails
                container.innerHTML = `<button data-slug="" onclick="filterNews('')" class="news-filter-btn active bg-brand-orange text-white px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition">Semua</button>`;
            }
        }

        async function fetchNews(isLoadMore = false) {
            if (newsState.isLoading) return;
            newsState.isLoading = true;

            // UI Loading State
            if(isLoadMore) {
                const btnMore = document.getElementById('btn-news-load-more');
                if(btnMore) btnMore.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memuat...';
            } else {
                document.getElementById('news-grid').innerHTML = '<div class="col-span-full text-center py-20"><div class="animate-spin inline-block w-8 h-8 border-4 border-slate-200 border-t-orange-500 rounded-full mb-4"></div><p class="text-slate-400">Memuat berita terbaru...</p></div>';
            }

            // KONSTRUKSI URL API
            let apiURL = `https://public-api.wordpress.com/rest/v1.1/sites/${WORDPRESS_SITE}/posts/?number=${NEWS_PER_PAGE}&page=${newsState.page}`;
            
            // 1. Jika ada kata kunci pencarian (Search Box)
            if (newsState.search) {
                apiURL += `&search=${encodeURIComponent(newsState.search)}`;
            }
            
            // 2. Jika ada filter kategori
            if (newsState.category) {
                apiURL += `&category=${encodeURIComponent(newsState.category)}`;
            }

            try {
                const res = await fetch(apiURL);
                const data = await res.json();
                
                newsState.isLoading = false;
                newsState.isLoaded = true;

                if (data.posts.length < NEWS_PER_PAGE) newsState.hasMore = false;
                else newsState.hasMore = true;

                if (isLoadMore) {
                    newsState.posts = [...newsState.posts, ...data.posts]; 
                } else {
                    newsState.posts = data.posts; 
                    document.getElementById('news-grid').innerHTML = ''; 
                }

                if (newsState.posts.length === 0) {
                    let pesanKosong = "Tidak ada berita ditemukan.";
                    if (newsState.category) {
                        pesanKosong = `Belum ada berita di kategori ini.`;
                    }

                    document.getElementById('news-grid').innerHTML = `
                        <div class="col-span-full text-center py-20 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                            <i class="fas fa-newspaper text-4xl text-gray-300 mb-3"></i>
                            <p class="text-gray-500">${pesanKosong}</p>
                            <button onclick="resetNewsFilter()" class="mt-4 text-brand-orange font-bold hover:underline">Reset Filter</button>
                        </div>`;
                } else {
                    renderNewsGrid(isLoadMore ? data.posts : newsState.posts, isLoadMore);
                }

                const btnMore = document.getElementById('btn-news-load-more');
                if(btnMore) {
                    btnMore.innerHTML = 'Muat Lebih Banyak <i class="fas fa-sync-alt ml-2"></i>';
                    if(newsState.hasMore) btnMore.classList.remove('hidden');
                    else btnMore.classList.add('hidden');
                }

            } catch (err) {
                console.error(err);
                newsState.isLoading = false;
                document.getElementById('news-grid').innerHTML = '<p class="text-center text-red-500 col-span-full">Gagal memuat berita. Periksa koneksi.</p>';
            }
        }

        function renderNewsGrid(postsToRender, appendMode) {
            const container = document.getElementById('news-grid');
            let html = '';
            let startIndex = appendMode ? (newsState.posts.length - postsToRender.length) : 0;

            postsToRender.forEach((post, i) => {
                const globalIndex = startIndex + i;
                const img = post.featured_image || 'https://via.placeholder.com/600x400?text=Lazismu';
                const date = new Date(post.date).toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'});
                
                html += `
                <div class="bg-white rounded-2xl shadow-sm hover:shadow-xl transition duration-300 overflow-hidden flex flex-col h-full border border-slate-100 group cursor-pointer fade-in" onclick="openNewsModal(${globalIndex})">
                    <div class="relative h-56 overflow-hidden bg-slate-100">
                        <img src="${img}" alt="${post.title}" class="w-full h-full object-cover transition duration-700 group-hover:scale-105">
                        <div class="absolute top-3 right-3 bg-white/90 backdrop-blur px-2 py-1 rounded text-xs font-bold text-gray-600 shadow">
                            ${date}
                        </div>
                    </div>
                    <div class="p-6 flex flex-col flex-grow">
                        <h3 class="font-bold text-lg text-slate-800 mb-3 line-clamp-2 group-hover:text-brand-orange transition">${post.title}</h3>
                        <p class="text-slate-500 text-sm line-clamp-3 mb-4 flex-grow">${stripHtml(post.excerpt)}</p>
                        <div class="pt-4 border-t border-slate-100 flex items-center justify-between">
                            <span class="text-xs font-bold text-brand-orange uppercase tracking-wide">Baca Selengkapnya</span>
                            <i class="fas fa-arrow-right text-slate-300 group-hover:text-brand-orange transition transform group-hover:translate-x-1"></i>
                        </div>
                    </div>
                </div>`;
            });

            if(appendMode) container.innerHTML += html;
            else container.innerHTML = html;
        }

        function handleNewsSearch(e) {
            if (e.key === 'Enter') {
                newsState.search = e.target.value;
                newsState.page = 1;
                newsState.hasMore = true;
                fetchNews();
            }
        }

        function filterNews(cat) {
            newsState.category = cat;
            newsState.search = '';
            document.getElementById('news-search-input').value = '';
            newsState.page = 1;
            newsState.hasMore = true;

            document.querySelectorAll('.news-filter-btn').forEach(btn => {
                // Use robust data-slug matching
                const btnSlug = btn.getAttribute('data-slug');
                if(btnSlug === cat) {
                    btn.classList.remove('bg-gray-100', 'text-gray-600');
                    btn.classList.add('bg-brand-orange', 'text-white');
                } else {
                    btn.classList.add('bg-gray-100', 'text-gray-600');
                    btn.classList.remove('bg-brand-orange', 'text-white');
                }
            });

            fetchNews();
        }

        function loadMoreNews() {
            newsState.page++;
            fetchNews(true);
        }

        function resetNewsFilter() {
            filterNews('');
        }

        function openNewsModal(index) {
            const post = newsState.posts[index];
            if(!post) return;

            const modal = document.getElementById('news-modal');
            const panel = document.getElementById('news-modal-panel');
            const container = document.getElementById('news-modal-content');
            const date = new Date(post.date).toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
            const img = post.featured_image || 'https://via.placeholder.com/1200x600';

            // Render Content
            container.innerHTML = `
                <div class="relative h-64 md:h-80 w-full bg-slate-900">
                    <img src="${img}" class="w-full h-full object-contain" alt="Detail">
                    <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent opacity-90"></div>
                    <div class="absolute bottom-0 left-0 p-8 w-full">
                        <span class="bg-brand-orange text-white px-3 py-1 rounded text-xs font-bold mb-3 inline-block shadow">Berita Lazismu</span>
                        <h2 class="text-2xl md:text-3xl font-bold text-white leading-tight drop-shadow-md mb-2">${post.title}</h2>
                        <div class="flex items-center gap-4 text-sm text-slate-300">
                            <span><i class="far fa-calendar-alt mr-2"></i> ${date}</span>
                        </div>
                    </div>
                </div>
                <div class="p-8 md:p-10 overflow-y-auto">
                    <div class="wp-content text-lg text-slate-700">
                        ${post.content}
                    </div>
                    <div class="mt-10 pt-6 border-t border-slate-100 text-center">
                        <p class="text-slate-400 text-sm mb-4">Bagikan kebaikan ini:</p>
                        <div class="flex justify-center gap-3">
                            <a href="https://wa.me/?text=${encodeURIComponent(post.title + ' ' + post.URL)}" target="_blank" class="w-10 h-10 rounded-full bg-green-500 text-white hover:scale-110 transition flex items-center justify-center"><i class="fab fa-whatsapp"></i></a>
                            <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(post.URL)}" target="_blank" class="w-10 h-10 rounded-full bg-blue-600 text-white hover:scale-110 transition flex items-center justify-center"><i class="fab fa-facebook-f"></i></a>
                        </div>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                panel.classList.remove('scale-95');
                panel.classList.add('scale-100');
            }, 10);
            document.body.style.overflow = 'hidden';
        }

        function closeNewsModal() {
            const modal = document.getElementById('news-modal');
            const panel = document.getElementById('news-modal-panel');
            
            modal.classList.add('opacity-0');
            panel.classList.remove('scale-100');
            panel.classList.add('scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
            document.body.style.overflow = 'auto';
        }

        function stripHtml(html) {
            let tmp = document.createElement("DIV");
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || "";
        }


        // --- REKAPITULASI LOGIC ---
        function setupRekapLogic() {
             const lvlSelect = document.getElementById('rekap-level-select');
             const clsSelect = document.getElementById('rekap-kelas-select');
             const btnExport = document.getElementById('btn-export-pdf');
             
             if(!lvlSelect || !clsSelect) return;

             lvlSelect.onchange = () => {
                 const lvl = lvlSelect.value;
                 clsSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';
                 
                 if (lvl && santriDB[lvl]) {
                     clsSelect.disabled = false;
                     const classes = Object.keys(santriDB[lvl]).sort();
                     classes.forEach(cls => {
                         const opt = document.createElement('option');
                         opt.value = cls;
                         opt.innerText = `Kelas ${cls}`;
                         clsSelect.appendChild(opt);
                     });
                 } else {
                     clsSelect.disabled = true;
                 }
                 toggleRekapDisplay(false);
             };

             clsSelect.onchange = () => {
                 const cls = clsSelect.value;
                 if(cls) {
                     toggleRekapDisplay(true);
                     renderRekapTable(cls);
                 } else {
                     toggleRekapDisplay(false);
                 }
             };

             if(btnExport) btnExport.onclick = () => exportRekapPDF();
        }

        function toggleRekapDisplay(show) {
             const ph = document.getElementById('rekap-placeholder');
             const sum = document.getElementById('rekap-summary');
             const tbl = document.getElementById('rekap-table-container');
             const btnExport = document.getElementById('btn-export-pdf');

             if(show) {
                 ph.classList.add('hidden');
                 sum.classList.remove('hidden');
                 tbl.classList.remove('hidden');
                 if(btnExport) btnExport.disabled = false;
             } else {
                 ph.classList.remove('hidden');
                 sum.classList.add('hidden');
                 tbl.classList.add('hidden');
                 if(btnExport) btnExport.disabled = true;
             }
        }

        function renderRekapTable(cls) {
            const tbody = document.getElementById('rekap-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';

            const level = cls.charAt(0);
            const students = santriDB[level] ? santriDB[level][cls] : [];
            
            if(!students) return;

            let totalKelas = 0;
            
            students.forEach((s, index) => {
                let qris = 0, transfer = 0, tunai = 0;

                riwayatData.allData.forEach(d => {
                    if(d.NamaSantri && d.NamaSantri.includes(s.nama) && (d.KelasSantri === cls || d.rombelSantri === cls)) {
                         const nom = parseInt(d.Nominal) || 0;
                         if(d.MetodePembayaran === 'QRIS') qris += nom;
                         else if(d.MetodePembayaran === 'Transfer') transfer += nom;
                         else tunai += nom;
                    }
                });
                const subtotal = qris + transfer + tunai;
                totalKelas += subtotal;

                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-white' : 'bg-slate-50';
                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-slate-900">${index + 1}</td>
                    <td class="px-6 py-4 font-bold text-slate-700 whitespace-nowrap">${s.nama}</td>
                    <td class="px-6 py-4 text-right font-mono text-slate-500 whitespace-nowrap">${qris > 0 ? formatRupiah(qris) : '-'}</td>
                    <td class="px-6 py-4 text-right font-mono text-slate-500 whitespace-nowrap">${transfer > 0 ? formatRupiah(transfer) : '-'}</td>
                    <td class="px-6 py-4 text-right font-mono text-slate-500 whitespace-nowrap">${tunai > 0 ? formatRupiah(tunai) : '-'}</td>
                    <td class="px-6 py-4 text-right font-bold text-orange-600 whitespace-nowrap">${formatRupiah(subtotal)}</td>
                `;
                tbody.appendChild(tr);
            });

            const meta = classMetaData[cls] || { wali: 'Belum Ditentukan', musyrif: 'Belum Ditentukan' };
            const elWali = document.getElementById('rekap-wali');
            const elMusyrif = document.getElementById('rekap-musyrif');
            const elTotal = document.getElementById('rekap-total-kelas');
            
            if(elWali) elWali.innerText = meta.wali;
            if(elMusyrif) elMusyrif.innerText = meta.musyrif;
            if(elTotal) elTotal.innerText = formatRupiah(totalKelas);
        }

        function exportRekapPDF() {
            if (!window.jspdf) {
                showToast("Library PDF belum dimuat.", "error");
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const clsSelect = document.getElementById('rekap-kelas-select');
            const cls = clsSelect ? clsSelect.value : '';
            const date = new Date().toLocaleDateString('id-ID').replace(/\//g, '-');
            const meta = classMetaData[cls] || { wali: '-', musyrif: '-' };
            
            doc.setFontSize(18);
            doc.setTextColor(241, 90, 34); 
            doc.text("REKAPITULASI PEROLEHAN ZIS", 14, 20);
            
            doc.setFontSize(12);
            doc.setTextColor(100);
            doc.text(`Kelas: ${cls}`, 14, 30);
            doc.text(`Tanggal: ${date}`, 14, 36);
            doc.text(`Wali Kelas: ${meta.wali}`, 120, 30);
            doc.text(`Musyrif: ${meta.musyrif}`, 120, 36);

            doc.autoTable({
                html: '#rekap-table-container table',
                startY: 45,
                theme: 'grid',
                headStyles: { fillColor: [241, 90, 34] },
                styles: { fontSize: 8 },
            });

            const totalEl = document.getElementById('rekap-total-kelas');
            const total = totalEl ? totalEl.innerText : 'Rp 0';
            
            doc.setFontSize(12);
            doc.setTextColor(0);
            const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY : 50;
            doc.text(`Total Perolehan: ${total}`, 14, finalY + 10);

            doc.save(`Rekap ZIS_Kelas ${cls}_${date}.pdf`);
        }


        // --- WIZARD LOGIC ---
        const STEP_TITLES = [
            { title: "Pilih Jenis Kebaikan", subtitle: "Niat Suci Dimulai" },
            { title: "Tentukan Nominal", subtitle: "Semoga Rezeki Berkah" },
            { title: "Isi Data Muzakki/Munfiq", subtitle: "Menyambung Silaturahmi" },
            { title: "Metode Pembayaran", subtitle: "Mudah dan Aman" },
            { title: "Konfirmasi Akhir", subtitle: "Menjemput Ridho-Nya" }
        ];

        function updateStepTitle(step) {
            const titleEl = document.getElementById('wizard-title');
            const subEl = document.getElementById('wizard-subtitle');
            const data = STEP_TITLES[step - 1];
            if(data && titleEl && subEl) {
                titleEl.innerText = data.title;
                subEl.innerText = data.subtitle;
            }
        }

        function goToStep(step) {
            document.querySelectorAll('.donasi-step-container').forEach(s => s.classList.add('hidden'));
            const target = document.getElementById(`donasi-step-${step}`);
            if (target) {
                target.classList.remove('hidden');
                target.classList.remove('animate-fade-in-up');
                void target.offsetWidth; 
                target.classList.add('animate-fade-in-up');
            }

            const indicator = document.getElementById('wizard-step-indicator');
            const bar = document.getElementById('wizard-progress-bar');
            
            if(indicator) indicator.innerText = `Step ${step}/5`;
            if(bar) bar.style.width = `${step * 20}%`;
            
            updateStepTitle(step);
            
            const wizard = document.getElementById('donasi-wizard');
            if(wizard) wizard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function setupWizardLogic() {
            // STEP 1
            document.querySelectorAll('.choice-button').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.choice-button').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    
                    const type = btn.dataset.type;
                    donasiData.type = type;
                    donasiData.subType = null;

                    const infaqOpts = document.getElementById('infaq-options');
                    const zakatFitrah = document.getElementById('zakat-fitrah-checker');
                    const zakatMaal = document.getElementById('zakat-maal-checker');
                    const step1Nav = document.getElementById('step-1-nav-default');

                    if(infaqOpts) infaqOpts.classList.add('hidden');
                    if(zakatFitrah) zakatFitrah.classList.add('hidden');
                    if(zakatMaal) zakatMaal.classList.add('hidden');
                    if(step1Nav) step1Nav.classList.add('hidden');

                    if(type === 'Infaq' && infaqOpts) infaqOpts.classList.remove('hidden');
                    else if(type === 'Zakat Fitrah' && zakatFitrah) zakatFitrah.classList.remove('hidden');
                    else if(type === 'Zakat Maal' && zakatMaal) zakatMaal.classList.remove('hidden');
                };
            });

            document.querySelectorAll('.sub-choice-button').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.sub-choice-button').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    donasiData.subType = btn.dataset.typeInfaq; 
                    const step1Nav = document.getElementById('step-1-nav-default');
                    if(step1Nav) step1Nav.classList.remove('hidden');
                };
            });

            const fitrahInput = document.getElementById('fitrah-jumlah-orang');
            if (fitrahInput) {
                fitrahInput.oninput = (e) => {
                    const total = (parseInt(e.target.value) || 0) * 37500;
                    const totalInput = document.getElementById('fitrah-total');
                    if(totalInput) totalInput.value = formatRupiah(total);
                    donasiData.nominal = total;
                };
            }
            
            const btnFitrahNext = document.getElementById('btn-fitrah-next');
            if (btnFitrahNext) {
                btnFitrahNext.onclick = () => {
                    if(donasiData.nominal < 37500) return showToast("Minimal 1 jiwa");
                    goToStep(3);
                };
            }

            const btnZakatCheck = document.getElementById('zakat-check-button');
            if (btnZakatCheck) {
                btnZakatCheck.onclick = () => {
                    const emasEl = document.getElementById('harga-emas');
                    const hasilEl = document.getElementById('penghasilan-bulanan');
                    const emas = parseInt(emasEl.value.replace(/\D/g,'')) || 0;
                    const hasil = parseInt(hasilEl.value.replace(/\D/g,'')) || 0;
                    const nisab = (emas * 85) / 12;
                    
                    const resultDiv = document.getElementById('zakat-result');
                    const msg = document.getElementById('zakat-result-message');
                    const btnMaal = document.getElementById('btn-maal-next');
                    const btnSkip = document.getElementById('zakat-lanjutkan-infaq');

                    if(resultDiv) resultDiv.classList.remove('hidden');

                    if(hasil >= nisab) {
                        const zakat = hasil * 0.025;
                        if(msg) msg.innerHTML = `<span class="text-green-600 block">WAJIB ZAKAT</span>Kewajiban: ${formatRupiah(zakat)}`;
                        donasiData.nominal = zakat;
                        if(btnMaal) btnMaal.classList.remove('hidden');
                        if(btnSkip) btnSkip.classList.add('hidden');
                    } else {
                        if(msg) msg.innerHTML = `<span class="text-orange-600 block">BELUM WAJIB</span>Belum mencapai nishab (${formatRupiah(nisab)})`;
                        if(btnMaal) btnMaal.classList.add('hidden');
                        if(btnSkip) btnSkip.classList.remove('hidden');
                    }
                };
            }
            
            const btnMaalNext = document.getElementById('btn-maal-next');
            if (btnMaalNext) btnMaalNext.onclick = () => goToStep(3);
            
            const btnZakatSkip = document.getElementById('zakat-lanjutkan-infaq');
            if (btnZakatSkip) {
                btnZakatSkip.onclick = () => {
                    const infaqBtn = document.querySelector('[data-type="Infaq"]');
                    if(infaqBtn) infaqBtn.click();
                };
            }

            const btnNextStep2 = document.querySelector('[data-next-step="2"]');
            if (btnNextStep2) {
                btnNextStep2.onclick = () => {
                    if(donasiData.type === 'Infaq' && !donasiData.subType) return showToast("Pilih peruntukan infaq terlebih dahulu");
                    goToStep(2);
                };
            }

            // STEP 2
            document.querySelectorAll('.nominal-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.nominal-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    donasiData.nominal = parseInt(btn.dataset.nominal);
                    const customInput = document.getElementById('nominal-custom');
                    if(customInput) customInput.value = formatRupiah(donasiData.nominal);
                };
            });
            
            const nominalCustom = document.getElementById('nominal-custom');
            if (nominalCustom) {
                nominalCustom.addEventListener('input', function() {
                    let val = this.value.replace(/\D/g, '');
                    donasiData.nominal = parseInt(val) || 0;
                    this.value = formatRupiah(donasiData.nominal);
                    document.querySelectorAll('.nominal-btn').forEach(b => b.classList.remove('selected'));
                });
            }
            
            const btnNextStep3 = document.querySelector('[data-next-step="3"]');
            if (btnNextStep3) {
                btnNextStep3.onclick = () => {
                    if(donasiData.nominal < 1000) showToast("Nominal minimal Rp 1.000");
                    else goToStep(3);
                };
            }

            // STEP 3
            const santriLevel = document.getElementById('santri-level-select');
            const santriRombel = document.getElementById('santri-rombel-select');
            const santriNama = document.getElementById('santri-nama-select');

            if (santriLevel) {
                santriLevel.onchange = () => {
                    if(santriRombel) {
                        santriRombel.innerHTML = '<option value="">Rombel</option>';
                        santriRombel.disabled = true;
                    }
                    if(santriNama) {
                        santriNama.innerHTML = '<option value="">Pilih Nama Santri</option>';
                        santriNama.disabled = true;
                    }

                    const lvl = santriLevel.value;
                    if(lvl && santriDB[lvl]) {
                        Object.keys(santriDB[lvl]).forEach(r => {
                            if(santriRombel) santriRombel.innerHTML += `<option value="${r}">${r}</option>`;
                        });
                        if(santriRombel) santriRombel.disabled = false;
                    }
                };
            }

            if (santriRombel) {
                santriRombel.onchange = () => {
                    if(santriNama) {
                        santriNama.innerHTML = '<option value="">Pilih Nama Santri</option>';
                        santriNama.disabled = true;
                    }

                    const lvl = santriLevel.value;
                    const rmb = santriRombel.value;
                    if(lvl && rmb && santriDB[lvl][rmb]) {
                        santriDB[lvl][rmb].forEach(s => {
                            if(santriNama) santriNama.innerHTML += `<option value="${s.nama}::${s.nis}::${s.rombel}">${s.nama}</option>`;
                        });
                        if(santriNama) santriNama.disabled = false;
                    }
                };
            }

            if (santriNama) {
                santriNama.onchange = () => {
                    if(santriNama.value) {
                        const [nama, nis, rombel] = santriNama.value.split('::');
                        donasiData.namaSantri = nama;
                        donasiData.nisSantri = nis;
                        donasiData.rombelSantri = rombel;

                        const radioAnSantri = document.getElementById('radio-an-santri');
                        if (radioAnSantri) {
                            radioAnSantri.disabled = false;
                            if(radioAnSantri.checked) {
                                const nameInput = document.getElementById('nama-muzakki-input');
                                if(nameInput) nameInput.value = `A/n Santri: ${nama}`;
                            }
                        }
                    }
                };
            }

            document.querySelectorAll('input[name="donatur-tipe"]').forEach(r => {
                r.onchange = (e) => {
                    donasiData.donaturTipe = e.target.value;
                    const santriDetails = document.getElementById('santri-details');
                    const alumniInput = document.getElementById('input-alumni-tahun');
                    const radioAnSantri = document.getElementById('radio-an-santri');
                    const checkAlumniDiv = document.getElementById('div-check-alumni'); 
                    const checkAlsoAlumni = document.getElementById('check-also-alumni');

                    if (radioAnSantri) radioAnSantri.disabled = true;
                    if(radioAnSantri && radioAnSantri.checked) {
                         const manualRadio = document.querySelector('input[name="nama-choice"][value="manual"]');
                         if(manualRadio) manualRadio.click();
                    }

                    if(e.target.value === 'santri') {
                        if(santriDetails) santriDetails.classList.remove('hidden');
                        if(checkAlumniDiv) checkAlumniDiv.classList.remove('hidden'); 
                        if(checkAlsoAlumni && checkAlsoAlumni.checked) {
                            if(alumniInput) alumniInput.classList.remove('hidden');
                        } else {
                            if(alumniInput) alumniInput.classList.add('hidden');
                        }
                    } else {
                        if(santriDetails) santriDetails.classList.add('hidden');
                        if(checkAlumniDiv) checkAlumniDiv.classList.remove('hidden'); 
                        if(checkAlsoAlumni && checkAlsoAlumni.checked) {
                            if(alumniInput) alumniInput.classList.remove('hidden');
                        } else {
                            if(alumniInput) alumniInput.classList.add('hidden');
                        }
                    }
                };
            });

            const checkAlsoAlumni = document.getElementById('check-also-alumni');
            if(checkAlsoAlumni) {
                checkAlsoAlumni.onchange = (e) => {
                    const alumniInput = document.getElementById('input-alumni-tahun');
                    if(alumniInput) {
                         if(e.target.checked) {
                            alumniInput.classList.remove('hidden');
                        } else {
                            alumniInput.classList.add('hidden');
                        }
                    }
                };
            }

            document.querySelectorAll('input[name="nama-choice"]').forEach(r => {
                r.onchange = (e) => {
                    const input = document.getElementById('nama-muzakki-input');
                    if(!input) return;

                    if(e.target.value === 'hamba') {
                        input.value = "Hamba Allah";
                        input.readOnly = true;
                    } else if (e.target.value === 'santri') {
                        if(donasiData.namaSantri) {
                            input.value = `A/n Santri: ${donasiData.namaSantri}`;
                            input.readOnly = true;
                        } else {
                            showToast("Pilih nama santri terlebih dahulu");
                            const manualRadio = document.querySelector('input[name="nama-choice"][value="manual"]');
                            if(manualRadio) manualRadio.checked = true;
                        }
                    } else {
                        input.value = "";
                        input.readOnly = false;
                        input.focus();
                    }
                };
            });

            const btnNextStep4 = document.querySelector('[data-next-step="4"]');
            if (btnNextStep4) {
                btnNextStep4.onclick = () => {
                    const nameInput = document.getElementById('nama-muzakki-input');
                    const hpInput = document.getElementById('no-hp');
                    const alamatInput = document.getElementById('alamat');
                    const emailInput = document.getElementById('email');
                    const doaInput = document.getElementById('pesan-doa');
                    const nikInput = document.getElementById('no-ktp'); 
                    const alumniInput = document.getElementById('alumni-tahun');
                    const checkAlsoAlumni = document.getElementById('check-also-alumni');

                    const isAlsoAlumni = checkAlsoAlumni ? checkAlsoAlumni.checked : false;
                    
                    if(donasiData.donaturTipe === 'santri' && !donasiData.namaSantri) return showToast("Wajib memilih data santri");
                    
                    if(isAlsoAlumni && alumniInput && !alumniInput.value) {
                        return showToast("Tahun lulus wajib diisi bagi Alumni");
                    }
                    
                    if(!nameInput || !nameInput.value) return showToast("Nama donatur wajib diisi");
                    if(!hpInput || !hpInput.value) return showToast("Nomor WhatsApp wajib diisi");
                    if(!alamatInput || !alamatInput.value) return showToast("Alamat wajib diisi"); 

                    donasiData.nama = nameInput.value;
                    donasiData.hp = hpInput.value;
                    donasiData.alamat = alamatInput.value;
                    donasiData.email = emailInput ? emailInput.value : '';
                    donasiData.doa = doaInput ? doaInput.value : '';
                    donasiData.nik = nikInput ? nikInput.value : ''; 
                    
                    if(isAlsoAlumni) {
                        donasiData.isAlumni = true;
                        donasiData.alumniTahun = alumniInput ? alumniInput.value : '';
                    } else {
                        donasiData.isAlumni = false;
                        donasiData.alumniTahun = '';
                    }

                    goToStep(4);
                };
            }

            // STEP 4
            const btnNextStep5 = document.querySelector('[data-next-step="5"]');
            if (btnNextStep5) {
                btnNextStep5.onclick = () => {
                    const method = document.querySelector('input[name="payment-method"]:checked');
                    if(!method) return showToast("Pilih metode pembayaran");
                    
                    donasiData.metode = method.value;
                    
                    document.getElementById('summary-type').innerText = donasiData.subType || donasiData.type;
                    document.getElementById('summary-nominal').innerText = formatRupiah(donasiData.nominal);
                    document.getElementById('summary-nama').innerText = donasiData.nama;
                    document.getElementById('summary-hp').innerText = donasiData.hp;
                    document.getElementById('summary-metode').innerText = donasiData.metode;

                    const santriRow = document.getElementById('summary-santri-row');
                    if(donasiData.namaSantri && donasiData.donaturTipe === 'santri') {
                        santriRow.classList.remove('hidden');
                        document.getElementById('summary-santri').innerText = `${donasiData.namaSantri} (${donasiData.rombelSantri})`;
                    } else {
                        santriRow.classList.add('hidden');
                    }

                    goToStep(5);
                };
            }

            // SUBMIT FINAL
            const btnSubmitFinal = document.getElementById('btn-submit-final');
            if (btnSubmitFinal) {
                btnSubmitFinal.onclick = async () => {
                    const btn = document.getElementById('btn-submit-final');
                    const check = document.getElementById('confirm-check');
                    
                    if(!check || !check.checked) return showToast("Mohon centang pernyataan konfirmasi");

                    btn.disabled = true;
                    btn.querySelector('.default-text').classList.add('hidden');
                    btn.querySelector('.loading-text').classList.remove('hidden');

                    const payload = {
                        "type": donasiData.subType || donasiData.type,
                        "nominal": donasiData.nominal,
                        "nama": donasiData.nama,
                        "hp": donasiData.hp,
                        "email": donasiData.email,
                        "alamat": donasiData.alamat,
                        "metode": donasiData.metode,
                        "doa": donasiData.doa,
                        "donaturTipe": donasiData.donaturTipe, 
                        "alumniTahun": donasiData.alumniTahun || "",
                        "DetailAlumni": donasiData.alumniTahun || "", 
                        "namaSantri": donasiData.namaSantri || "",
                        "nisSantri": donasiData.nisSantri || "",
                        "rombelSantri": donasiData.rombelSantri || "",
                        "NoKTP": donasiData.nik || "" 
                    };

                    try {
                        await fetch(GAS_API_URL, {
                            method: "POST",
                            headers: { "Content-Type": "text/plain" },
                            body: JSON.stringify({ action: "create", payload: payload })
                        });

                        const modal = document.getElementById('success-modal');
                        if(modal) modal.classList.remove('hidden');
                        
                        const waMsg = `Assalamu'alaikum, saya ingin konfirmasi donasi kebaikan:\n\nJenis: ${donasiData.subType || donasiData.type}\nNominal: ${formatRupiah(donasiData.nominal)}\nNama: ${donasiData.nama}\nMetode: ${donasiData.metode}\n${donasiData.namaSantri ? `Santri: ${donasiData.namaSantri} (${donasiData.rombelSantri})` : ''}`;
                        const btnWa = document.getElementById('btn-wa-confirm');
                        if(btnWa) btnWa.href = `https://wa.me/6281196961918?text=${encodeURIComponent(waMsg)}`;

                        // GENERATE PAYMENT INSTRUCTIONS
                        let paymentDetails = '';
                        if(donasiData.metode === 'QRIS') {
                             paymentDetails = `
                                <div class="text-center bg-slate-50 p-6 rounded-2xl border border-slate-100">
                                    <p class="font-bold text-slate-700 mb-4">Silakan Scan QRIS Berikut:</p>
                                    <div class="grid grid-cols-3 gap-4 mb-2">
                                        <div class="bg-white p-2 rounded-xl border border-slate-100 shadow-sm"><img src="https://drive.google.com/thumbnail?id=1sVzvP6AUz_bYJ31CzQG2io9oJvdMDywt" class="w-full rounded-lg"></div>
                                        <div class="bg-white p-2 rounded-xl border border-slate-100 shadow-sm"><img src="https://drive.google.com/thumbnail?id=1xNHeckecd8Pn_7dSOQ0KfGcl0I_FCY9V" class="w-full rounded-lg"></div>
                                        <div class="bg-white p-2 rounded-xl border border-slate-100 shadow-sm"><img src="https://drive.google.com/thumbnail?id=1BHYcMAUp3OiVeRx2HwjPPEu2StcYiUpm" class="w-full rounded-lg"></div>
                                    </div>
                                    <p class="text-xs text-slate-400">Mendukung semua e-wallet & m-banking</p>
                                </div>
                             `;
                        } else if(donasiData.metode === 'Transfer') {
                             paymentDetails = `
                                <div class="space-y-3">
                                    <div class="p-4 bg-white rounded-xl border border-slate-100 shadow-sm flex justify-between items-center"><div><span class="font-bold block text-slate-700">BNI</span><span class="text-sm font-mono text-slate-500">3440000348</span></div><button onclick="copyText('3440000348')" class="text-orange-500 text-sm font-bold hover:bg-orange-50 px-3 py-1 rounded-lg transition">Salin</button></div>
                                    <div class="p-4 bg-white rounded-xl border border-slate-100 shadow-sm flex justify-between items-center"><div><span class="font-bold block text-slate-700">BSI</span><span class="text-sm font-mono text-slate-500">7930030303</span></div><button onclick="copyText('7930030303')" class="text-teal-500 text-sm font-bold hover:bg-teal-50 px-3 py-1 rounded-lg transition">Salin</button></div>
                                    <div class="p-4 bg-white rounded-xl border border-slate-100 shadow-sm flex justify-between items-center"><div><span class="font-bold block text-slate-700">BPD DIY Syariah</span><span class="text-sm font-mono text-slate-500">801241004624</span></div><button onclick="copyText('801241004624')" class="text-blue-500 text-sm font-bold hover:bg-blue-50 px-3 py-1 rounded-lg transition">Salin</button></div>
                                </div>
                             `;
                        } else {
                            paymentDetails = `<div class="p-6 bg-blue-50 rounded-2xl text-center border border-blue-100"><div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 text-xl"><i class="fas fa-hand-holding-usd"></i></div><p class="text-blue-800 font-bold">Pembayaran Tunai</p><p class="text-blue-600 text-sm mt-1">Silakan serahkan donasi ke Kantor Layanan Lazismu Mu'allimin.</p></div>`;
                        }
                        
                        const prayerHTML = `
                            <div class="mb-8 text-center bg-green-50 p-6 rounded-2xl border border-green-100">
                                <p class="font-arabic text-2xl text-green-800 mb-4 leading-loose font-bold">
                                              
                                </p>
                                <p class="text-green-700 text-sm italic">
                                    "Semoga Allah memberikan pahala atas apa yang engkau berikan, dan semoga Allah memberkahimu atas apa yang masih ada di tanganmu dan menjadikannya sebagai pembersih (dosa) bagimu."
                                </p>
                            </div>
                        `;

                        const instrContent = document.getElementById('instruction-content');
                        if(instrContent) instrContent.innerHTML = prayerHTML + paymentDetails;
                        
                        const wizard = document.getElementById('donasi-wizard');
                        if(wizard) wizard.classList.add('hidden');
                        
                        const paymentInstr = document.getElementById('donasi-payment-instructions');
                        if(paymentInstr) paymentInstr.classList.remove('hidden');

                    } catch (e) {
                        showToast("Gagal mengirim data, periksa koneksi internet.", "error");
                        btn.disabled = false;
                        btn.querySelector('.default-text').classList.remove('hidden');
                        btn.querySelector('.loading-text').classList.add('hidden');
                    }
                };
            }

            const successContinue = document.getElementById('success-modal-continue');
            if(successContinue) {
                successContinue.onclick = () => {
                    const modal = document.getElementById('success-modal');
                    if(modal) modal.classList.add('hidden');
                    const paymentInstr = document.getElementById('donasi-payment-instructions');
                    if(paymentInstr) paymentInstr.scrollIntoView({behavior:'smooth'});
                };
            }

            document.querySelectorAll('[data-prev-step]').forEach(btn => {
                btn.onclick = () => goToStep(parseInt(btn.dataset.prevStep));
            });
        }

        // --- HISTORY LOGIC ---
        function setupHistoryLogic() {
            const prevBtn = document.getElementById('riwayat-prev');
            const nextBtn = document.getElementById('riwayat-next');

            if(prevBtn) {
                prevBtn.onclick = () => {
                    if(riwayatData.currentPage > 1) {
                        riwayatData.currentPage--;
                        renderRiwayatList();
                        renderPagination();
                    }
                };
            }
            if(nextBtn) {
                nextBtn.onclick = () => {
                    const totalPages = Math.ceil(riwayatData.allData.length / riwayatData.itemsPerPage);
                    if(riwayatData.currentPage < totalPages) {
                        riwayatData.currentPage++;
                        renderRiwayatList();
                        renderPagination();
                    }
                };
            }

            ['filter-jenis', 'filter-metode', 'filter-start-date', 'filter-end-date'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.onchange = () => {
                    riwayatData.currentPage = 1; 
                    renderRiwayatList();
                    renderPagination(); 
                };
            });
            
            document.querySelectorAll('.time-filter-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.time-filter-btn').forEach(b => {
                        b.classList.remove('bg-brand-orange', 'text-white');
                        b.classList.add('bg-slate-100', 'text-slate-500');
                    });
                    btn.classList.remove('bg-slate-100', 'text-slate-500');
                    btn.classList.add('bg-brand-orange', 'text-white');
                    
                    timeFilterState = btn.dataset.time;
                    riwayatData.currentPage = 1;
                    renderRiwayatList();
                    renderPagination();
                }
            });

            const resetBtn = document.getElementById('btn-reset-filter');
            if(resetBtn) {
                resetBtn.onclick = () => {
                    document.getElementById('filter-jenis').value = 'all';
                    document.getElementById('filter-metode').value = 'all';
                    document.getElementById('filter-start-date').value = '';
                    document.getElementById('filter-end-date').value = '';
                    
                    timeFilterState = 'all';
                    document.querySelectorAll('.time-filter-btn').forEach(b => {
                        b.classList.remove('bg-brand-orange', 'text-white');
                        b.classList.add('bg-slate-100', 'text-slate-500');
                    });

                    riwayatData.currentPage = 1;
                    renderRiwayatList();
                    renderPagination();
                }
            }
        }

        async function loadRiwayat() {
            if(riwayatData.isLoaded) return;
            
            const loader = document.getElementById('riwayat-loading');
            const content = document.getElementById('riwayat-content');
            
            if(loader) loader.classList.remove('hidden');
            if(content) content.classList.add('hidden');

            try {
                const res = await fetch(GAS_API_URL);
                const json = await res.json();
                
                if(json.status === 'success') {
                    riwayatData.allData = json.data.reverse(); 
                    riwayatData.isLoaded = true;
                    
                    calculateStats();
                    renderHomeLatestDonations();
                    renderPagination();
                    renderRiwayatList();

                    if(loader) loader.classList.add('hidden');
                    if(content) content.classList.remove('hidden');
                    
                    if(riwayatData.allData.length === 0) {
                        const noData = document.getElementById('riwayat-no-data');
                        if(noData) noData.classList.remove('hidden');
                    }
                }
            } catch(e) {
                if(loader) loader.innerHTML = '<p class="text-red-500">Gagal memuat data.</p>';
            }
        }

        function renderHomeLatestDonations() {
            const container = document.getElementById('home-latest-donations');
            if(!container) return;

            const latest = riwayatData.allData.slice(0, 8);

            if (latest.length === 0) {
                container.innerHTML = '<div class="text-center col-span-full py-4 text-slate-400 text-sm">Belum ada donasi. Jadilah yang pertama!</div>';
                return;
            }

            let html = latest.map(item => {
                let iconClass = 'fa-donate';
                let bgIcon = 'bg-slate-100 text-slate-400';
                let bgBadge = 'bg-slate-50 text-slate-600';
                
                const type = item.JenisDonasi || item.type || ""; 
                const subType = item.SubJenis || item.subType || "";
                const displayType = subType || type;

                if(displayType.includes('Fitrah')) { 
                    iconClass = 'fa-leaf'; 
                    bgIcon = 'bg-emerald-100 text-emerald-600';
                    bgBadge = 'bg-emerald-50 text-emerald-700 border-emerald-100';
                }
                else if(displayType.includes('Maal')) { 
                    iconClass = 'fa-coins'; 
                    bgIcon = 'bg-amber-100 text-amber-600'; 
                    bgBadge = 'bg-amber-50 text-amber-700 border-amber-100';
                }
                else { 
                    iconClass = 'fa-hand-holding-heart'; 
                    bgIcon = 'bg-orange-100 text-brand-orange'; 
                    bgBadge = 'bg-orange-50 text-orange-700 border-orange-100';
                }

                return `
                <div class="bg-white rounded-2xl p-5 shadow-sm hover:shadow-md border border-slate-100 transition-all duration-300 group hover:-translate-y-1">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-full ${bgIcon} flex items-center justify-center text-xl group-hover:scale-110 transition-transform duration-300">
                            <i class="fas ${iconClass}"></i>
                        </div>
                        <span class="text-xs font-bold ${bgBadge} border px-2 py-1 rounded-full truncate max-w-[120px]">${displayType}</span>
                    </div>
                    <div>
                        <h5 class="font-bold text-slate-800 text-sm mb-1 truncate" title="${item.NamaDonatur || 'Hamba Allah'}">
                            ${item.NamaDonatur || 'Hamba Allah'}
                        </h5>
                        <div class="flex items-baseline gap-1">
                            <span class="text-xs text-slate-400 font-medium">Rp</span>
                            <span class="text-lg font-black text-slate-800 group-hover:text-brand-orange transition-colors">${parseInt(item.Nominal).toLocaleString('id-ID')}</span>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-50 flex items-center gap-2 text-[10px] text-slate-400">
                            <i class="far fa-clock"></i>
                            <span>${timeAgo(item.Timestamp)}</span>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            // View All Card
            html += `
                <div onclick="showPage('riwayat')" class="bg-slate-50 p-5 rounded-2xl hover:bg-white hover:shadow-md border border-slate-100 border-dashed hover:border-solid transition-all duration-300 cursor-pointer flex flex-col items-center justify-center h-full min-h-[180px] group">
                     <div class="w-12 h-12 rounded-full bg-white text-slate-400 flex items-center justify-center mb-3 shadow-sm group-hover:bg-brand-orange group-hover:text-white transition-all duration-300">
                        <i class="fas fa-arrow-right text-lg"></i>
                     </div>
                     <span class="font-bold text-sm text-slate-500 group-hover:text-brand-orange transition-colors">Lihat Semua</span>
                     <span class="text-xs text-slate-400 mt-1">Jejak Kebaikan Lainnya</span>
                </div>
            `;

            container.innerHTML = html;
        }

        function calculateStats() {
            const data = riwayatData.allData;
            let total = 0;
            let todayTotal = 0;
            let maxDonation = 0;
            let maxDonationName = "-"; 
            const todayStr = new Date().toDateString();
            
            const classMapMTs = {}, classMapMA = {};
            const santriDonasiMTs = {}, santriDonasiMA = {};
            const santriFreqMTs = {}, santriFreqMA = {};
            const donationTypes = {};

            let totalFitrah = 0;
            let totalMaal = 0;
            let totalInfaq = 0;

            data.forEach(d => {
                const val = parseInt(d.Nominal) || 0;
                total += val;
                if(val > maxDonation) {
                    maxDonation = val;
                    maxDonationName = d.NamaDonatur || "Hamba Allah"; 
                }
                
                const dateObj = new Date(d.Timestamp);
                if(dateObj.toDateString() === todayStr) todayTotal += val;
                
                const typeName = d.JenisDonasi || "Lainnya";
                donationTypes[typeName] = (donationTypes[typeName] || 0) + 1;

                if(typeName.includes('Fitrah')) totalFitrah += val;
                else if(typeName.includes('Maal')) totalMaal += val;
                else if(typeName.includes('Infaq')) totalInfaq += val;

                const rombel = d.KelasSantri || d.rombelSantri;
                const nama = d.NamaSantri || d.namaSantri;

                if(rombel && nama) {
                    const lvl = parseInt(rombel.charAt(0));
                    const isMTs = lvl <= 3;
                    const mapClass = isMTs ? classMapMTs : classMapMA;
                    const mapSantri = isMTs ? santriDonasiMTs : santriDonasiMA;
                    const mapFreq = isMTs ? santriFreqMTs : santriFreqMA;

                    mapClass[rombel] = (mapClass[rombel] || 0) + val;
                    const key = `${nama} (${rombel})`;
                    mapSantri[key] = (mapSantri[key] || 0) + val;
                    mapFreq[key] = (mapFreq[key] || 0) + 1;
                }
            });
            
            const getPopular = (obj) => {
                let popular = "-";
                let max = 0;
                for(const [key, count] of Object.entries(obj)) {
                    if(count > max) { max = count; popular = key; }
                }
                return popular;
            };

            const popularType = getPopular(donationTypes);

            const setText = (id, txt) => { 
                const el = document.getElementById(id);
                if(el) el.innerText = txt; 
            };
            const getMax = (map, type='val') => {
                let maxK = 'N/A', maxV = 0;
                for(const [k,v] of Object.entries(map)) {
                    if(v > maxV) { maxV = v; maxK = k; }
                }
                return { key: maxK, val: type === 'val' ? formatRupiah(maxV) : maxV + 'x' };
            };
            
            const elTotal = document.getElementById('stat-total-donasi');
            if(elTotal) animateValue(elTotal, 0, total, 2000, true);
            
            const elTrans = document.getElementById('stat-total-transaksi');
            if(elTrans) animateValue(elTrans, 0, data.length, 1500);
            
            const elRata = document.getElementById('stat-donasi-rata');
            if(elRata) animateValue(elRata, 0, data.length ? total/data.length : 0, 1500, true);
            
            const elMax = document.getElementById('stat-donasi-tertinggi');
            if(elMax) animateValue(elMax, 0, maxDonation, 1500, true);
            setText('stat-donasi-tertinggi-nama', maxDonationName); 

            const elRTotal = document.getElementById('stat-r-total');
            if(elRTotal) animateValue(elRTotal, 0, total, 2000, true);

            const elRTrans = document.getElementById('stat-r-transaksi');
            if(elRTrans) animateValue(elRTrans, 0, data.length, 1500);
            
            const elRHari = document.getElementById('stat-r-hari-ini');
            if(elRHari) animateValue(elRHari, 0, todayTotal, 1000, true);
            
            const elRTipe = document.getElementById('stat-r-tipe-top');
            if(elRTipe) elRTipe.innerText = popularType;

            const elDetFitrah = document.getElementById('stat-detail-fitrah');
            if(elDetFitrah) animateValue(elDetFitrah, 0, totalFitrah, 1500, true);
            
            const elDetMaal = document.getElementById('stat-detail-maal');
            if(elDetMaal) animateValue(elDetMaal, 0, totalMaal, 1500, true);

            const elDetInfaq = document.getElementById('stat-detail-infaq');
            if(elDetInfaq) animateValue(elDetInfaq, 0, totalInfaq, 1500, true);
            
            const mtsClass = getMax(classMapMTs);
            setText('stat-mts-kelas-max', mtsClass.key);
            setText('stat-mts-kelas-total', mtsClass.val);
            
            const mtsSantri = getMax(santriDonasiMTs);
            setText('stat-mts-santri-max-donasi', mtsSantri.key.split('(')[0]);
            setText('stat-mts-santri-total-donasi', mtsSantri.val);

            const mtsFreq = getMax(santriFreqMTs, 'freq');
            setText('stat-mts-santri-freq-nama', mtsFreq.key.split('(')[0]);
            setText('stat-mts-santri-freq-val', mtsFreq.val);

            const maClass = getMax(classMapMA);
            setText('stat-ma-kelas-max', maClass.key);
            setText('stat-ma-kelas-total', maClass.val);
            
            const maSantri = getMax(santriDonasiMA);
            setText('stat-ma-santri-max-donasi', maSantri.key.split('(')[0]);
            setText('stat-ma-santri-total-donasi', maSantri.val);

            const maFreq = getMax(santriFreqMA, 'freq');
            setText('stat-ma-santri-freq-nama', maFreq.key.split('(')[0]);
            setText('stat-ma-santri-freq-val', maFreq.val);
        }

        function renderPagination() {
            const items = getFilteredData();
            const totalPages = Math.ceil(items.length / riwayatData.itemsPerPage);
            
            const pageInfo = document.getElementById('riwayat-page-info');
            if(pageInfo) pageInfo.innerText = `Page ${riwayatData.currentPage} of ${totalPages || 1}`;
            
            const prevBtn = document.getElementById('riwayat-prev');
            if(prevBtn) prevBtn.disabled = riwayatData.currentPage === 1;
            
            const nextBtn = document.getElementById('riwayat-next');
            if(nextBtn) nextBtn.disabled = riwayatData.currentPage >= totalPages || totalPages === 0;
        }

        function getFilteredData() {
             let filtered = riwayatData.allData;
             const typeFilter = document.getElementById('filter-jenis') ? document.getElementById('filter-jenis').value : 'all';
             const methodFilter = document.getElementById('filter-metode') ? document.getElementById('filter-metode').value : 'all';
             const startDate = document.getElementById('filter-start-date').value;
             const endDate = document.getElementById('filter-end-date').value;

             if(typeFilter !== 'all') {
                 filtered = filtered.filter(d => d.JenisDonasi === typeFilter || d.type === typeFilter);
             }
             if(methodFilter !== 'all') {
                 filtered = filtered.filter(d => d.MetodePembayaran === methodFilter);
             }
             
             if (startDate || endDate) {
                const start = startDate ? new Date(startDate) : new Date('1970-01-01');
                const end = endDate ? new Date(endDate) : new Date();
                end.setHours(23, 59, 59, 999); 

                filtered = filtered.filter(d => {
                    const itemDate = new Date(d.Timestamp);
                    return itemDate >= start && itemDate <= end;
                });
             }

             if(timeFilterState !== 'all') {
                 const now = new Date();
                 const startOfWeek = new Date(now);
                 startOfWeek.setDate(now.getDate() - now.getDay());
                 startOfWeek.setHours(0,0,0,0);

                 filtered = filtered.filter(d => {
                    const date = new Date(d.Timestamp);
                    if(timeFilterState === 'today') return date.toDateString() === now.toDateString();
                    if(timeFilterState === 'week') return date >= startOfWeek;
                    if(timeFilterState === 'month') return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
                    if(timeFilterState === 'year') return date.getFullYear() === now.getFullYear();
                    return true;
                 });
             }

             return filtered;
        }

        function renderRiwayatList() {
            const container = document.getElementById('riwayat-list-container');
            if(!container) return;

            const items = getFilteredData();
            const start = (riwayatData.currentPage - 1) * riwayatData.itemsPerPage;
            const end = start + riwayatData.itemsPerPage;
            const visibleItems = items.slice(start, end);
            
            if(visibleItems.length === 0) {
                 container.innerHTML = '<p class="text-center text-slate-400 py-4">Tidak ada data.</p>';
                 return;
            }

            container.innerHTML = visibleItems.map(item => {
                let iconClass = 'fa-donate text-slate-400';
                let bgIcon = 'bg-slate-100';
                
                const type = item.JenisDonasi || item.type || ""; 
                const subType = item.SubJenis || item.subType || "";
                const displayType = subType || type;

                if(displayType.includes('Fitrah')) { iconClass = 'fa-leaf text-emerald-500'; bgIcon = 'bg-emerald-50'; }
                else if(displayType.includes('Maal')) { iconClass = 'fa-coins text-yellow-500'; bgIcon = 'bg-yellow-50'; }
                else { iconClass = 'fa-hand-holding-heart text-indigo-500'; bgIcon = 'bg-indigo-50'; }

                const date = new Date(item.Timestamp).toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'});
                
                const alumniYear = item.DetailAlumni || item.detailAlumni;
                const alumniText = alumniYear ? `<span class="text-xs text-orange-500 font-semibold block mt-0.5">Alumni ${alumniYear}</span>` : '';
                
                return `
                <div class="soft-card p-4 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full ${bgIcon} flex items-center justify-center text-lg shrink-0">
                            <i class="fas ${iconClass}"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800 text-sm md:text-base">
                                ${item.NamaDonatur || 'Hamba Allah'}
                            </h4>
                            ${alumniText}
                            <p class="text-xs text-slate-500 mt-1">${displayType}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="block font-black text-slate-700">${formatRupiah(item.Nominal)}</span>
                        <span class="text-xs text-slate-400">${date}</span>
                    </div>
                </div>
                `;
            }).join('');
        }
    </script>
</body>
</html>









