<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cetak Kwitansi Lazismu (Auto)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Kalam:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --primary: #ff7b00;
            --bg-grad: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            --shadow: 0 10px 30px -10px rgba(0,0,0,0.2);
            --ink-color: #000080; /* Warna Tinta Biru (Seragam) */
            --font-size-isian: 16pt; /* Ukuran Font (Seragam) */
        }

        /* --- UI UTAMA --- */
        body { 
            margin: 0; padding: 20px; 
            background: var(--bg-grad); 
            display: flex; flex-direction: column; align-items: center; 
            font-family: 'Inter', sans-serif; min-height: 100vh; overflow-x: hidden; 
        }

        /* Tombol Cetak Melayang */
        .print-fab {
            position: fixed; bottom: 30px; z-index: 100;
            background: var(--primary); color: white;
            padding: 15px 30px; border-radius: 50px;
            font-weight: bold; cursor: pointer; border: none;
            box-shadow: 0 5px 20px rgba(255, 123, 0, 0.4);
            display: flex; gap: 10px; align-items: center;
            transition: transform 0.2s;
        }
        .print-fab:hover { transform: scale(1.05); }

        /* Workspace (Area Kertas) */
        .workspace { position: relative; margin-top: 20px; transform-origin: top center; box-shadow: var(--shadow); }
        .page-container { 
            width: 210mm; height: 148mm; 
            position: relative; 
            background-image: url('MasterTemplate.png'); 
            background-size: 100% 100%; 
            background-color: white; 
            border-radius: 4px; font-family: 'Lato', sans-serif; color: #000; overflow: hidden; 
        }

        /* --- SETTINGAN FONT & WARNA SERAGAM --- */
        .editable { 
            position: absolute; line-height: 1.0; white-space: nowrap; overflow: hidden; 
            
            /* FONT & WARNA SERAGAM DI SINI */
            font-family: 'Kalam', cursive; 
            font-weight: 700; 
            font-size: var(--font-size-isian); 
            color: var(--ink-color); 
            
            background: transparent; border: none; 
            z-index: 10; min-width: 10px; min-height: 24px; padding: 2px 4px; 
            display: flex; align-items: flex-end; 
            pointer-events: none;
        }

        /* KOORDINAT PRESISI */
        .pos-nomor { top: 18.0mm; left: 70.4mm; width: 44.1mm; }
        
        .tgl-box { justify-content: center; } 
        .tgl-d1 { top: 19mm; left: 163.0mm; width: 5.0mm; } .tgl-d2 { top: 19mm; left: 168.3mm; width: 4.8mm; }
        .tgl-m1 { top: 19mm; left: 174.9mm; width: 5.0mm; } .tgl-m2 { top: 19mm; left: 180.2mm; width: 4.8mm; }
        .tgl-y1 { top: 19mm; left: 187.3mm; width: 5.0mm; } .tgl-y2 { top: 19mm; left: 192.1mm; width: 5.0mm; }

        .nama { top: 32.2mm; left: 89.7mm; width: 110.6mm; height: 8mm; }
        .alamat { top: 38.0mm; left: 89.7mm; width: 110.6mm; height: 8mm; font-size: 14pt; } /* Alamat agak kecil dikit biar muat */
        .no-hp { top: 45.6mm; left: 152.9mm; width: 47.1mm; }

        /* Kanan Rata untuk Jenis */
        .jenis-zakat { top: 69.5mm; left: 65.0mm; width: 36.1mm; justify-content: flex-end; padding-right: 5px; }
        .nominal-zakat { top: 69.5mm; left: 111.9mm; width: 64.0mm; }
        
        .jenis-infaq { top: 75.5mm; left: 65.0mm; width: 36.1mm; justify-content: flex-end; padding-right: 5px; }
        .nominal-infaq { top: 75.5mm; left: 111.9mm; width: 66.1mm; }
        
        .jenis-lain { top: 81.5mm; left: 65.0mm; width: 36.1mm; justify-content: flex-end; padding-right: 5px; }
        .nominal-lain { top: 81.5mm; left: 111.9mm; width: 66.1mm; }
        
        .nominal-total { top: 88.0mm; left: 111.9mm; width: 66.1mm; font-weight: 800; font-size: 18pt; } /* Total sedikit lebih besar */

        /* Centang & Bank (Warna & Ukuran disamakan) */
        .chk { 
            justify-content: center; align-items: center; 
            font-size: 24pt; /* Centang tetap besar agar pas kotak */
            line-height: 0.8; 
            color: var(--ink-color); /* Biru */
        }
        .centang-kas { top: 68.0mm; left: 178.5mm; width: 6.0mm; }
        .centang-bank { top: 74.0mm; left: 178.5mm; width: 6.0mm; }
        .nama-bank { top: 75.0mm; left: 193.0mm; width: 20mm; font-size: 14pt; color: var(--ink-color); }

        .terbilang-1 { top: 95.1mm; left: 89.7mm; width: 110.0mm; font-size: 14pt; }
        .terbilang-2 { top: 101.2mm; left: 89.7mm; width: 110.0mm; font-size: 14pt; }

        /* Gambar & QR */
        .box-qrcode { 
            position: absolute; top: 113mm; left: 132mm; 
            width: 15mm; height: 15mm; z-index: 20; opacity: 0.95;
            display: flex; justify-content: center; align-items: center;
        }
        .img-overlay { position: absolute; z-index: 5; mix-blend-mode: multiply; opacity: 0.85; pointer-events: none; }
        .stempel { top: 110.2mm; left: 62.4mm; width: 39.9mm; }
        .tempat-ttd { top: 114.2mm; left: 70.4mm; width: 61.4mm; }

        /* Tanda Tangan (Warna Biru) */
        .penyetor { 
            top: 127.9mm; left: 149.5mm; width: 39.0mm; 
            justify-content: center; 
            font-size: 14pt; /* Samakan */
            color: var(--ink-color); /* Biru */
        }

        @media print {
            body { background: none; margin: 0; padding: 0; display: block; }
            .print-fab { display: none !important; }
            .workspace { transform: none !important; margin: 0; box-shadow: none; }
            .page-container { margin: 0; border-radius: 0; page-break-after: always; }
            @page { size: A5 landscape; margin: 0; }
        }
    </style>
</head>
<body>

    <button class="print-fab" onclick="window.print()">
        <i class="fas fa-print"></i> Cetak Kwitansi
    </button>

    <div class="workspace" id="workspace">
        <div class="page-container" id="kuitansiArea">
            
            <div id="nomor" class="editable pos-nomor"></div>

            <div id="d1" class="editable tgl-box tgl-d1"></div>
            <div id="d2" class="editable tgl-box tgl-d2"></div>
            <div id="m1" class="editable tgl-box tgl-m1"></div>
            <div id="m2" class="editable tgl-box tgl-m2"></div>
            <div id="y1" class="editable tgl-box tgl-y1"></div>
            <div id="y2" class="editable tgl-box tgl-y2"></div>

            <div id="nama" class="editable nama"></div>
            <div id="alamat" class="editable alamat"></div>
            <div id="no-hp" class="editable no-hp"></div>

            <div id="jenis-zakat" class="editable jenis-zakat"></div>
            <div id="nominal-zakat" class="editable nominal-zakat"></div>

            <div id="jenis-infaq" class="editable jenis-infaq"></div>
            <div id="nominal-infaq" class="editable nominal-infaq"></div>

            <div id="jenis-lain" class="editable jenis-lain"></div>
            <div id="nominal-lain" class="editable nominal-lain"></div>

            <div id="nominal-total" class="editable nominal-total"></div>

            <div id="chk-kas" class="editable chk centang-kas"></div>
            <div id="chk-bank" class="editable chk centang-bank"></div>
            <div id="nama-bank" class="editable nama-bank"></div>

            <div id="terbilang-1" class="editable terbilang-1"></div>
            <div id="terbilang-2" class="editable terbilang-2"></div>

            <div id="qrcode" class="box-qrcode"></div>

            <img class="img-overlay stempel" src="stempel.png" onerror="this.style.display='none'">
            <img class="img-overlay tempat-ttd" src="ttd.png" onerror="this.style.display='none'">

            <div id="penyetor" class="editable penyetor"></div>
        </div>
    </div>

<script>
    // --- SKRIP OTOMATIS (READ ONLY) ---

    const Utils = {
        // Poin 5: Hapus Rp di depan
        formatRupiah: (angka) => parseInt(angka).toLocaleString('id-ID'),
        
        terbilang: (angka) => {
            const bil = ["", "Satu", "Dua", "Tiga", "Empat", "Lima", "Enam", "Tujuh", "Delapan", "Sembilan", "Sepuluh", "Sebelas"];
            let n = Math.abs(parseInt(angka));
            if (n < 12) return " " + bil[n];
            else if (n < 20) return Utils.terbilang(n - 10) + " Belas";
            else if (n < 100) return Utils.terbilang(Math.floor(n / 10)) + " Puluh" + Utils.terbilang(n % 10);
            else if (n < 200) return " Seratus" + Utils.terbilang(n - 100);
            else if (n < 1000) return Utils.terbilang(Math.floor(n / 100)) + " Ratus" + Utils.terbilang(n % 100);
            else if (n < 2000) return " Seribu" + Utils.terbilang(n - 1000);
            else if (n < 1000000) return Utils.terbilang(Math.floor(n / 1000)) + " Ribu" + Utils.terbilang(n % 1000);
            else if (n < 1000000000) return Utils.terbilang(Math.floor(n / 1000000)) + " Juta" + Utils.terbilang(n % 1000000);
            return "";
        },
        set: (id, val) => {
            const el = document.getElementById(id);
            if (el) el.innerText = val || "";
        },
        cleanLabel: (str, removeWord) => {
            if(!str) return "";
            return str.replace(new RegExp(removeWord, 'gi'), '').trim();
        }
    };

    window.onload = function() {
        const rawData = localStorage.getItem('tiket_cetak_kwitansi');
        
        if (!rawData) {
            alert("⚠️ Data tidak ditemukan! Mohon buka halaman ini melalui tombol kwitansi di dashboard.");
            return;
        }
        
        const data = JSON.parse(rawData);

        // A. Tanggal (Diambil dari Data Transaksi)
        const tgl = new Date(data.tanggal || new Date());
        const d = String(tgl.getDate()).padStart(2, '0');
        const m = String(tgl.getMonth() + 1).padStart(2, '0');
        const y = String(tgl.getFullYear()).slice(-2);

        Utils.set('d1', d[0]); Utils.set('d2', d[1]);
        Utils.set('m1', m[0]); Utils.set('m2', m[1]);
        Utils.set('y1', y[0]); Utils.set('y2', y[1]);

        // B. Nomor Invoice (Poin 1: Maksimal 3 Digit belakang)
        let noInv = data.nomor || "";
        if(!noInv || noInv.length < 5) {
            const dateStr = y + m + d; 
            // Buat 3 digit random jika tidak ada nomor urut dari database
            const rand3 = Math.floor(Math.random() * 999) + 1;
            const seq = String(rand3).padStart(3, '0');
            noInv = `INV/${dateStr}/${seq}`;
        }
        Utils.set('nomor', noInv);

        // C. Identitas & Poin 4 (Auto Tambah Nol HP)
        Utils.set('nama', data.nama);
        Utils.set('alamat', data.alamat || "-");
        
        let hpRaw = (data.hp || "-").toString().trim();
        if (hpRaw !== "-" && !hpRaw.startsWith('0') && !hpRaw.startsWith('62') && !hpRaw.startsWith('+')) {
            hpRaw = "0" + hpRaw;
        }
        Utils.set('no-hp', hpRaw);
        
        Utils.set('penyetor', `( ${data.nama} )`);

        // D. Nominal & Penempatan Jenis
        const nominal = parseInt(data.nominal);
        const jenis = (data.jenis || "").toLowerCase();
        const sub = (data.sub || "").toLowerCase();
        const fmtNominal = Utils.formatRupiah(nominal); 

        // Reset
        Utils.set('jenis-zakat',''); Utils.set('nominal-zakat','');
        Utils.set('jenis-infaq',''); Utils.set('nominal-infaq','');
        Utils.set('jenis-lain','');  Utils.set('nominal-lain','');

        if (jenis.includes('zakat') || jenis.includes('fitrah') || jenis.includes('maal')) {
            // ZAKAT
            Utils.set('nominal-zakat', fmtNominal);
            let labelZakat = Utils.cleanLabel(data.jenis, 'Zakat');
            if(!labelZakat && jenis.includes('fitrah')) labelZakat = 'Fitrah';
            if(!labelZakat && jenis.includes('maal')) labelZakat = 'Maal';
            Utils.set('jenis-zakat', labelZakat);

        } else if (jenis.includes('infaq') || jenis.includes('shadaqah')) {
            // INFAQ
            Utils.set('nominal-infaq', fmtNominal);
            let labelInfaq = "";
            if (sub && !sub.includes('infaq')) {
                labelInfaq = sub;
            } else {
                labelInfaq = Utils.cleanLabel(data.jenis, 'Infaq');
            }
            labelInfaq = labelInfaq.replace('Pengembangan', '').trim();
            Utils.set('jenis-infaq', labelInfaq);

        } else {
            // LAINNYA
            Utils.set('nominal-lain', fmtNominal);
            Utils.set('jenis-lain', data.jenis);
        }
        Utils.set('nominal-total', fmtNominal);

        // E. Terbilang (Poin 7: Hapus Pagar)
        let textBilang = Utils.terbilang(nominal) + " Rupiah"; 
        if (textBilang.length > 50) {
            let cutIndex = textBilang.lastIndexOf(' ', 50);
            Utils.set('terbilang-1', textBilang.substring(0, cutIndex));
            Utils.set('terbilang-2', textBilang.substring(cutIndex));
        } else {
            Utils.set('terbilang-1', textBilang);
        }

        // F. Metode Pembayaran (Centang V)
        const mtd = (data.metode || "").toLowerCase();
        if (mtd === 'tunai' || mtd === 'cash') {
            Utils.set('chk-kas', 'V');
        } else {
            Utils.set('chk-bank', 'V');
            Utils.set('nama-bank', data.metode || 'Transfer');
        }

        // G. Generate QR Code
        new QRCode(document.getElementById("qrcode"), {
            text: `LAZISMU MU'ALLIMIN VALID\nNo: ${noInv}\nTgl: ${d}-${m}-20${y}\nNama: ${data.nama}\nJml: ${fmtNominal}`,
            width: 55, height: 55,
            colorDark : "#000000", colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.L
        });
    };
</script>
</body>
</html>
